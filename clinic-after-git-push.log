ðŸš€ Starting Enhanced Pipeline - Manual + Gap-Based AI Test Flow
===================================================================

ðŸŽ¯ Target Directory: /home/sigmoid/test-repos/clinic

ðŸ§¹ Cleaning previous coverage data...
âœ… Coverage data cleaned

ðŸ” Running detect_manual_tests.py on target repo...
ðŸ” Scanning repository for manual test directories in: /home/sigmoid/test-repos/clinic

ðŸ“Š Detection Result:
{
  "manual_tests_found": true,
  "manual_test_paths": [
    "/home/sigmoid/test-repos/clinic/tests"
  ],
  "test_files_count": 5,
  "test_dirs_detail": {
    "/home/sigmoid/test-repos/clinic/tests": [
      "/home/sigmoid/test-repos/clinic/tests/test_middleware.py",
      "/home/sigmoid/test-repos/clinic/tests/test_api.py",
      "/home/sigmoid/test-repos/clinic/tests/conftest.py",
      "/home/sigmoid/test-repos/clinic/tests/test_model.py",
      "/home/sigmoid/test-repos/clinic/tests/test_auth.py"
    ]
  }
}

ðŸ“ Manual Tests Found: True
ðŸ“‚ Test Paths: /home/sigmoid/test-repos/clinic/tests

âœ… Manual test cases detected. Running pytest with coverage analysis...

ðŸ“¦ Installing project dependencies...
Requirement already satisfied: fastapi==0.104.1 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 2)) (0.104.1)
Requirement already satisfied: uvicorn==0.24.0 in ./venv/lib/python3.12/site-packages (from uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (0.24.0)
Requirement already satisfied: pydantic==2.5.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 4)) (2.5.0)
Requirement already satisfied: torch==2.4.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (2.4.0)
Requirement already satisfied: transformers==4.35.2 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (4.35.2)
Requirement already satisfied: tokenizers==0.15.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 9)) (0.15.0)
Requirement already satisfied: accelerate==0.24.1 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 10)) (0.24.1)
Requirement already satisfied: python-jose==3.3.0 in ./venv/lib/python3.12/site-packages (from python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (3.3.0)
Requirement already satisfied: python-multipart==0.0.6 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 14)) (0.0.6)
Requirement already satisfied: prometheus-client==0.19.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 17)) (0.19.0)
Requirement already satisfied: aiofiles==23.2.1 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 20)) (23.2.1)
Requirement already satisfied: httpx==0.25.2 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 21)) (0.25.2)
Requirement already satisfied: psutil==5.9.6 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 24)) (5.9.6)
Requirement already satisfied: pytest==7.4.3 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 27)) (7.4.3)
Requirement already satisfied: pytest-asyncio==0.21.1 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 28)) (0.21.1)
Requirement already satisfied: pytest-cov==4.1.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 29)) (4.1.0)
Requirement already satisfied: black==23.10.1 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 30)) (23.10.1)
Requirement already satisfied: isort==5.12.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 31)) (5.12.0)
Requirement already satisfied: flake8==6.1.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 32)) (6.1.0)
Requirement already satisfied: mypy==1.7.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 33)) (1.7.0)
Requirement already satisfied: bandit==1.7.5 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (1.7.5)
Requirement already satisfied: safety==2.3.4 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 35)) (2.3.4)
Requirement already satisfied: python-dotenv==1.0.0 in ./venv/lib/python3.12/site-packages (from -r /home/sigmoid/test-repos/clinic/requirements.txt (line 38)) (1.0.0)
Requirement already satisfied: anyio<4.0.0,>=3.7.1 in ./venv/lib/python3.12/site-packages (from fastapi==0.104.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 2)) (3.7.1)
Requirement already satisfied: starlette<0.28.0,>=0.27.0 in ./venv/lib/python3.12/site-packages (from fastapi==0.104.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 2)) (0.27.0)
Requirement already satisfied: typing-extensions>=4.8.0 in ./venv/lib/python3.12/site-packages (from fastapi==0.104.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 2)) (4.15.0)
Requirement already satisfied: annotated-types>=0.4.0 in ./venv/lib/python3.12/site-packages (from pydantic==2.5.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 4)) (0.7.0)
Requirement already satisfied: pydantic-core==2.14.1 in ./venv/lib/python3.12/site-packages (from pydantic==2.5.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 4)) (2.14.1)
Requirement already satisfied: click>=7.0 in ./venv/lib/python3.12/site-packages (from uvicorn==0.24.0->uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (8.3.0)
Requirement already satisfied: h11>=0.8 in ./venv/lib/python3.12/site-packages (from uvicorn==0.24.0->uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (0.16.0)
Requirement already satisfied: filelock in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (3.20.0)
Requirement already satisfied: sympy in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (1.14.0)
Requirement already satisfied: networkx in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (3.5)
Requirement already satisfied: jinja2 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (3.1.6)
Requirement already satisfied: fsspec in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (2025.10.0)
Requirement already satisfied: setuptools in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (80.9.0)
Requirement already satisfied: nvidia-cuda-nvrtc-cu12==12.1.105 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.105)
Requirement already satisfied: nvidia-cuda-runtime-cu12==12.1.105 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.105)
Requirement already satisfied: nvidia-cuda-cupti-cu12==12.1.105 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.105)
Requirement already satisfied: nvidia-cudnn-cu12==9.1.0.70 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (9.1.0.70)
Requirement already satisfied: nvidia-cublas-cu12==12.1.3.1 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.3.1)
Requirement already satisfied: nvidia-cufft-cu12==11.0.2.54 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (11.0.2.54)
Requirement already satisfied: nvidia-curand-cu12==10.3.2.106 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (10.3.2.106)
Requirement already satisfied: nvidia-cusolver-cu12==11.4.5.107 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (11.4.5.107)
Requirement already satisfied: nvidia-cusparse-cu12==12.1.0.106 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.0.106)
Requirement already satisfied: nvidia-nccl-cu12==2.20.5 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (2.20.5)
Requirement already satisfied: nvidia-nvtx-cu12==12.1.105 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.1.105)
Requirement already satisfied: triton==3.0.0 in ./venv/lib/python3.12/site-packages (from torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (3.0.0)
Requirement already satisfied: huggingface-hub<1.0,>=0.16.4 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (0.36.0)
Requirement already satisfied: numpy>=1.17 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (2.3.4)
Requirement already satisfied: packaging>=20.0 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (25.0)
Requirement already satisfied: pyyaml>=5.1 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (6.0.3)
Requirement already satisfied: regex!=2019.12.17 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (2025.11.3)
Requirement already satisfied: requests in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (2.32.5)
Requirement already satisfied: safetensors>=0.3.1 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (0.6.2)
Requirement already satisfied: tqdm>=4.27 in ./venv/lib/python3.12/site-packages (from transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (4.67.1)
Requirement already satisfied: ecdsa!=0.15 in ./venv/lib/python3.12/site-packages (from python-jose==3.3.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (0.19.1)
Requirement already satisfied: rsa in ./venv/lib/python3.12/site-packages (from python-jose==3.3.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (4.9.1)
Requirement already satisfied: pyasn1 in ./venv/lib/python3.12/site-packages (from python-jose==3.3.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (0.6.1)
Requirement already satisfied: certifi in ./venv/lib/python3.12/site-packages (from httpx==0.25.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 21)) (2025.10.5)
Requirement already satisfied: httpcore==1.* in ./venv/lib/python3.12/site-packages (from httpx==0.25.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 21)) (1.0.9)
Requirement already satisfied: idna in ./venv/lib/python3.12/site-packages (from httpx==0.25.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 21)) (3.11)
Requirement already satisfied: sniffio in ./venv/lib/python3.12/site-packages (from httpx==0.25.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 21)) (1.3.1)
Requirement already satisfied: iniconfig in ./venv/lib/python3.12/site-packages (from pytest==7.4.3->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 27)) (2.3.0)
Requirement already satisfied: pluggy<2.0,>=0.12 in ./venv/lib/python3.12/site-packages (from pytest==7.4.3->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 27)) (1.6.0)
Requirement already satisfied: coverage>=5.2.1 in ./venv/lib/python3.12/site-packages (from coverage[toml]>=5.2.1->pytest-cov==4.1.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 29)) (7.11.3)
Requirement already satisfied: mypy-extensions>=0.4.3 in ./venv/lib/python3.12/site-packages (from black==23.10.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 30)) (1.1.0)
Requirement already satisfied: pathspec>=0.9.0 in ./venv/lib/python3.12/site-packages (from black==23.10.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 30)) (0.12.1)
Requirement already satisfied: platformdirs>=2 in ./venv/lib/python3.12/site-packages (from black==23.10.1->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 30)) (4.5.0)
Requirement already satisfied: mccabe<0.8.0,>=0.7.0 in ./venv/lib/python3.12/site-packages (from flake8==6.1.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 32)) (0.7.0)
Requirement already satisfied: pycodestyle<2.12.0,>=2.11.0 in ./venv/lib/python3.12/site-packages (from flake8==6.1.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 32)) (2.11.1)
Requirement already satisfied: pyflakes<3.2.0,>=3.1.0 in ./venv/lib/python3.12/site-packages (from flake8==6.1.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 32)) (3.1.0)
Requirement already satisfied: GitPython>=1.0.1 in ./venv/lib/python3.12/site-packages (from bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (3.1.45)
Requirement already satisfied: stevedore>=1.20.0 in ./venv/lib/python3.12/site-packages (from bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (5.5.0)
Requirement already satisfied: rich in ./venv/lib/python3.12/site-packages (from bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (14.2.0)
Requirement already satisfied: dparse>=0.6.2 in ./venv/lib/python3.12/site-packages (from safety==2.3.4->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 35)) (0.6.4)
Requirement already satisfied: ruamel.yaml>=0.17.21 in ./venv/lib/python3.12/site-packages (from safety==2.3.4->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 35)) (0.18.16)
Requirement already satisfied: nvidia-nvjitlink-cu12 in ./venv/lib/python3.12/site-packages (from nvidia-cusolver-cu12==11.4.5.107->torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (12.9.86)
Requirement already satisfied: cryptography>=3.4.0 in ./venv/lib/python3.12/site-packages (from python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (46.0.3)
Requirement already satisfied: httptools>=0.5.0 in ./venv/lib/python3.12/site-packages (from uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (0.7.1)
Requirement already satisfied: uvloop!=0.15.0,!=0.15.1,>=0.14.0 in ./venv/lib/python3.12/site-packages (from uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (0.22.1)
Requirement already satisfied: watchfiles>=0.13 in ./venv/lib/python3.12/site-packages (from uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (1.1.1)
Requirement already satisfied: websockets>=10.4 in ./venv/lib/python3.12/site-packages (from uvicorn[standard]==0.24.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 3)) (15.0.1)
Requirement already satisfied: hf-xet<2.0.0,>=1.1.3 in ./venv/lib/python3.12/site-packages (from huggingface-hub<1.0,>=0.16.4->transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (1.2.0)
Requirement already satisfied: cffi>=2.0.0 in ./venv/lib/python3.12/site-packages (from cryptography>=3.4.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (2.0.0)
Requirement already satisfied: pycparser in ./venv/lib/python3.12/site-packages (from cffi>=2.0.0->cryptography>=3.4.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (2.23)
Requirement already satisfied: six>=1.9.0 in ./venv/lib/python3.12/site-packages (from ecdsa!=0.15->python-jose==3.3.0->python-jose[cryptography]==3.3.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 13)) (1.17.0)
Requirement already satisfied: gitdb<5,>=4.0.1 in ./venv/lib/python3.12/site-packages (from GitPython>=1.0.1->bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (4.0.12)
Requirement already satisfied: smmap<6,>=3.0.1 in ./venv/lib/python3.12/site-packages (from gitdb<5,>=4.0.1->GitPython>=1.0.1->bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (5.0.2)
Requirement already satisfied: ruamel.yaml.clib>=0.2.7 in ./venv/lib/python3.12/site-packages (from ruamel.yaml>=0.17.21->safety==2.3.4->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 35)) (0.2.14)
Requirement already satisfied: MarkupSafe>=2.0 in ./venv/lib/python3.12/site-packages (from jinja2->torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (3.0.3)
Requirement already satisfied: charset_normalizer<4,>=2 in ./venv/lib/python3.12/site-packages (from requests->transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (3.4.4)
Requirement already satisfied: urllib3<3,>=1.21.1 in ./venv/lib/python3.12/site-packages (from requests->transformers==4.35.2->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 8)) (2.5.0)
Requirement already satisfied: markdown-it-py>=2.2.0 in ./venv/lib/python3.12/site-packages (from rich->bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (4.0.0)
Requirement already satisfied: pygments<3.0.0,>=2.13.0 in ./venv/lib/python3.12/site-packages (from rich->bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (2.19.2)
Requirement already satisfied: mdurl~=0.1 in ./venv/lib/python3.12/site-packages (from markdown-it-py>=2.2.0->rich->bandit==1.7.5->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 34)) (0.1.2)
Requirement already satisfied: mpmath<1.4,>=1.1.0 in ./venv/lib/python3.12/site-packages (from sympy->torch==2.4.0->-r /home/sigmoid/test-repos/clinic/requirements.txt (line 7)) (1.3.0)

ðŸ“‚ Copying manual tests to local folder: ./tests/manual

âœ… Manual test files copied to ./tests/manual
ðŸ“„ Files:
./tests/manual/test_middleware.py
./tests/manual/test_api.py
./tests/manual/test_model.py
./tests/manual/test_auth.py

ðŸ§ª Running manual tests from local directory with coverage analysis: ./tests/manual

============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-7.4.3, pluggy-1.6.0 -- /home/sigmoid/TECH_DEMO/new-tech-demo/venv/bin/python3
cachedir: .pytest_cache
metadata: {'Python': '3.12.3', 'Platform': 'Linux-6.14.0-33-generic-x86_64-with-glibc2.39', 'Packages': {'pytest': '7.4.3', 'pluggy': '1.6.0'}, 'Plugins': {'html': '4.1.1', 'django': '4.11.1', 'asyncio': '0.21.1', 'Faker': '12.0.1', 'mock': '3.15.1', 'anyio': '3.7.1', 'metadata': '3.1.1', 'cov': '4.1.0'}}
rootdir: /home/sigmoid/TECH_DEMO/new-tech-demo
configfile: pytest.ini
plugins: html-4.1.1, django-4.11.1, asyncio-0.21.1, Faker-12.0.1, mock-3.15.1, anyio-3.7.1, metadata-3.1.1, cov-4.1.0
asyncio: mode=Mode.AUTO
collecting ... collected 88 items

tests/manual/test_api.py::TestHealthEndpoint::test_health_check_success PASSED [  1%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_success PASSED [  2%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_empty_sentence PASSED [  3%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[The patient denies chest pain.] PASSED [  4%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[He has a history of hypertension.] PASSED [  5%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[No signs of pneumonia were observed.] PASSED [  6%]
tests/manual/test_api.py::TestBatchPredictionEndpoint::test_batch_predict_success PASSED [  7%]
tests/manual/test_api.py::TestBatchPredictionEndpoint::test_batch_predict_empty_list PASSED [  9%]
tests/manual/test_api.py::TestRootEndpoint::test_root_endpoint PASSED    [ 10%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_conditional PASSED [ 11%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_uncertainty PASSED [ 12%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_no_rule PASSED [ 13%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_multiple_sentences PASSED [ 14%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_conditional_phrases_positive PASSED [ 15%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_conditional_phrases_negative PASSED [ 17%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_uncertainty_phrases_positive PASSED [ 18%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_uncertainty_phrases_negative PASSED [ 19%]
tests/manual/test_api.py::TestEnhancedPredictionEndpoints::test_predict_with_hybrid_pipeline PASSED [ 20%]
tests/manual/test_api.py::TestEnhancedPredictionEndpoints::test_batch_predict_with_hybrid_pipeline PASSED [ 21%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_no_api_keys PASSED  [ 22%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_with_api_keys PASSED [ 23%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_with_whitespace_api_keys PASSED [ 25%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_no_keys_required PASSED [ 26%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_valid PASSED  [ 27%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_invalid PASSED [ 28%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_health_endpoint FAILED [ 29%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_root_endpoint PASSED [ 30%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_metrics_endpoint PASSED [ 31%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_no_keys_required FAILED [ 32%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_missing_from_request FAILED [ 34%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_invalid FAILED [ 35%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_bearer FAILED [ 36%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_header FAILED [ 37%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_query_param FAILED [ 38%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key FAILED [ 39%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_multiple_keys PASSED [ 40%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_empty_key_string PASSED [ 42%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_whitespace_only PASSED [ 43%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_special_characters PASSED [ 44%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_case_sensitive PASSED [ 45%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_init PASSED [ 46%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_init_with_csp PASSED [ 47%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_dispatch_no_csp_http PASSED [ 48%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_dispatch_with_csp_https PASSED [ 50%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_init PASSED [ 51%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_with_x_forwarded_for PASSED [ 52%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_with_client PASSED [ 53%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_unknown PASSED [ 54%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_health_endpoint PASSED [ 55%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_under_limit PASSED [ 56%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_over_limit PASSED [ 57%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_init PASSED [ 59%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_with_x_forwarded_for PASSED [ 60%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_with_client PASSED [ 61%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_unknown PASSED [ 62%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_success PASSED [ 63%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_with_exception FAILED [ 64%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_init PASSED [ 65%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_success PASSED [ 67%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_error PASSED [ 68%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_exception PASSED [ 69%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_init PASSED [ 70%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_not_loaded PASSED [ 71%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_after_init PASSED [ 72%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_no_model PASSED [ 73%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_device_cuda_available PASSED [ 75%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_device_cuda_not_available PASSED [ 76%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_success FAILED [ 77%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_tokenizer_failure PASSED [ 78%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_model_failure PASSED [ 79%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_not_loaded PASSED [ 80%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_not_loaded PASSED [ 81%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_success FAILED [ 82%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_pipeline_error PASSED [ 84%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_success PASSED [ 85%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_list_result PASSED [ 86%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_nested_list_result PASSED [ 87%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_unexpected_result_type PASSED [ 88%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_success FAILED [ 89%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_success PASSED [ 90%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_single_result PASSED [ 92%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_get_model_info PASSED [ 93%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_get_model_info_cuda_available PASSED [ 94%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_empty_result PASSED [ 95%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_none_result PASSED [ 96%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_empty_results PASSED [ 97%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_mixed_result_types PASSED [ 98%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_unknown_label PASSED [100%]

=================================== FAILURES ===================================
_____________ TestVerifyAPIKey.test_verify_api_key_health_endpoint _____________

self = <manual.test_auth.TestVerifyAPIKey object at 0x749036885c40>
auth_client = <starlette.testclient.TestClient object at 0x748f6b106db0>

    def test_verify_api_key_health_endpoint(self, auth_client):
        """Test that health endpoint doesn't require API key"""
        response = auth_client.get("/health")
>       assert response.status_code == 200
E       assert 503 == 200
E        +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:55: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    app.main:main.py:229 Health check failed:
____________ TestVerifyAPIKey.test_verify_api_key_no_keys_required _____________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368c1e20>
auth_client = <starlette.testclient.TestClient object at 0x748f6b32b7d0>

    def test_verify_api_key_no_keys_required(self, auth_client):
        """Test endpoints when no API keys are required"""
        with patch.dict(os.environ, {"API_KEYS": "", "REQUIRE_API_KEY": "false"}):
            response = auth_client.get("/model/info")
>           assert response.status_code == 200
E           assert 503 == 200
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:71: AssertionError
__________ TestVerifyAPIKey.test_verify_api_key_missing_from_request ___________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368b3d70>
auth_client = <starlette.testclient.TestClient object at 0x748f6b104080>

    def test_verify_api_key_missing_from_request(self, auth_client):
        """Test API key verification when key is missing"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
            response = auth_client.get("/model/info")
>           assert response.status_code == 401
E           assert 503 == 401
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:79: AssertionError
_________________ TestVerifyAPIKey.test_verify_api_key_invalid _________________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368d4530>
auth_client = <starlette.testclient.TestClient object at 0x748f6b147dd0>

    def test_verify_api_key_invalid(self, auth_client):
        """Test API key verification with invalid key"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
            response = auth_client.get(
                "/model/info", headers={"Authorization": "Bearer invalid_key"}
            )
>           assert response.status_code == 401
E           assert 503 == 401
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:91: AssertionError
______________ TestVerifyAPIKey.test_verify_api_key_valid_bearer _______________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368d4ef0>
auth_client = <starlette.testclient.TestClient object at 0x748f6b427cb0>

    def test_verify_api_key_valid_bearer(self, auth_client):
        """Test API key verification with valid Bearer token"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
            response = auth_client.get(
                "/model/info", headers={"Authorization": "Bearer test_key"}
            )
>           assert response.status_code == 200
E           assert 503 == 200
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:103: AssertionError
______________ TestVerifyAPIKey.test_verify_api_key_valid_header _______________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368d7650>
auth_client = <starlette.testclient.TestClient object at 0x748f6b1f9f70>

    def test_verify_api_key_valid_header(self, auth_client):
        """Test API key verification with valid X-API-Key header"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
            response = auth_client.get("/model/info", headers={"X-API-Key": "test_key"})
>           assert response.status_code == 200
E           assert 503 == 200
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:111: AssertionError
____________ TestVerifyAPIKey.test_verify_api_key_valid_query_param ____________

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368d4140>
auth_client = <starlette.testclient.TestClient object at 0x748f6b106030>

    def test_verify_api_key_valid_query_param(self, auth_client):
        """Test API key verification with valid query parameter"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
            response = auth_client.get("/model/info?api_key=test_key")
>           assert response.status_code == 200
E           assert 503 == 200
E            +  where 503 = <Response [503 Service Unavailable]>.status_code

tests/manual/test_auth.py:119: AssertionError
___________ TestVerifyAPIKey.test_verify_api_key_logging_invalid_key ___________

self = <MagicMock name='logger.warning' id='128159325382864'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'warning' to have been called.

/usr/lib/python3.12/unittest/mock.py:913: AssertionError

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x7490368d0470>

    def test_verify_api_key_logging_invalid_key(self):
        """Test that invalid API key attempts are logged"""
        # Standard library imports
        from unittest.mock import Mock
    
        from app.auth import verify_api_key
    
        with patch.dict(
            os.environ, {"API_KEYS": "valid_key", "REQUIRE_API_KEY": "true"}
        ), patch("app.auth.logger") as mock_logger:
            mock_request = Mock()
            mock_request.url.path = "/api/test"
            mock_request.client = Mock()
            mock_request.client.host = "192.168.1.1"
            mock_request.headers = {}
            mock_request.query_params = {}
    
            # This should raise an exception and log the invalid attempt
            try:
                verify_api_key(mock_request, None)
            except Exception:
                pass
    
            # Verify that warning was logged for invalid key attempt
>           mock_logger.warning.assert_called()
E           AssertionError: Expected 'warning' to have been called.

tests/manual/test_auth.py:145: AssertionError
__________ TestRequestLoggingMiddleware.test_dispatch_with_exception ___________

request = <Mock id='128159325398240'>

    async def failing_call_next(request):
>       raise Exception("Test error")
E       Exception: Test error

tests/manual/test_middleware.py:248: Exception

During handling of the above exception, another exception occurred:

self = <app.middleware.RequestLoggingMiddleware object at 0x748f6b10a3c0>
request = <Mock id='128159325398240'>
call_next = <function TestRequestLoggingMiddleware.test_dispatch_with_exception.<locals>.failing_call_next at 0x748f6a624400>

    async def dispatch(
        self, request: Request, call_next: Callable[[Request], Awaitable[Response]]
    ) -> Response:
        start_time = time.time()
        request_id = request.headers.get(
            "X-Request-ID", f"req-{int(start_time * 1000)}"
        )
    
        logger.info(
            json.dumps(
                {
                    "event": "request_started",
                    "request_id": request_id,
                    "method": request.method,
                    "path": request.url.path,
                    "client_ip": self.get_client_id(request),
                    "timestamp": start_time,
                }
            )
        )
    
        try:
            response = await call_next(request)
    
            duration = time.time() - start_time
            logger.info(
                json.dumps(
                    {
                        "event": "request_completed",
                        "request_id": request_id,
                        "status_code": response.status_code,
                        "duration_ms": duration * 1000,
                        "timestamp": time.time(),
                    }
                )
            )
    
            response.headers["X-Request-ID"] = request_id
            return response
    
        except Exception as e:
            duration = time.time() - start_time
            logger.error(
                json.dumps(
                    {
                        "event": "request_failed",
                        "request_id": request_id,
                        "error": str(e),
                        "duration_ms": duration * 1000,
>                       "timestamp": time.time(),
                    }
                )
            )

../../test-repos/clinic/app/middleware.py:155: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1134: in __call__
    return self._mock_call(*args, **kwargs)
/usr/lib/python3.12/unittest/mock.py:1138: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='time' id='128159325398432'>, args = (), kwargs = {}
effect = <list_iterator object at 0x748f6b1d6aa0>

    def _execute_mock_call(self, /, *args, **kwargs):
        # separate from _increment_mock_call so that awaited functions are
        # executed separately from their call, also AsyncMock overrides this method
    
        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
                raise effect
            elif not _callable(effect):
>               result = next(effect)
E               StopIteration

/usr/lib/python3.12/unittest/mock.py:1195: StopIteration

The above exception was the direct cause of the following exception:

self = <manual.test_middleware.TestRequestLoggingMiddleware object at 0x7490365771d0>
middleware = <app.middleware.RequestLoggingMiddleware object at 0x748f6b10a3c0>

    @pytest.mark.asyncio
    async def test_dispatch_with_exception(self, middleware):
        """Test request dispatch with exception"""
        mock_request = Mock()
        mock_request.method = "POST"
        mock_request.url.path = "/api/test"
        mock_request.headers = {}
        mock_request.client = None
    
        async def failing_call_next(request):
            raise Exception("Test error")
    
        with patch("time.time", side_effect=[1000.0, 1000.3]), patch(
            "app.middleware.logger"
        ) as mock_logger:
            with pytest.raises(Exception, match="Test error"):
>               await middleware.dispatch(mock_request, failing_call_next)
E               RuntimeError: coroutine raised StopIteration

tests/manual/test_middleware.py:254: RuntimeError

During handling of the above exception, another exception occurred:

self = <manual.test_middleware.TestRequestLoggingMiddleware object at 0x7490365771d0>
middleware = <app.middleware.RequestLoggingMiddleware object at 0x748f6b10a3c0>

    @pytest.mark.asyncio
    async def test_dispatch_with_exception(self, middleware):
        """Test request dispatch with exception"""
        mock_request = Mock()
        mock_request.method = "POST"
        mock_request.url.path = "/api/test"
        mock_request.headers = {}
        mock_request.client = None
    
        async def failing_call_next(request):
            raise Exception("Test error")
    
        with patch("time.time", side_effect=[1000.0, 1000.3]), patch(
            "app.middleware.logger"
        ) as mock_logger:
>           with pytest.raises(Exception, match="Test error"):
E           AssertionError: Regex pattern did not match.
E            Regex: 'Test error'
E            Input: 'coroutine raised StopIteration'

tests/manual/test_middleware.py:253: AssertionError
______________ TestClinicalAssertionModel.test_load_model_success ______________

self = <manual.test_model.TestClinicalAssertionModel object at 0x748f6b8f4050>
mock_cuda = <MagicMock name='is_available' id='128159325401360'>
mock_pipeline = <MagicMock name='TextClassificationPipeline' id='128159313887888'>
mock_model_class = <MagicMock name='from_pretrained' id='128159325385216'>
mock_tokenizer = <MagicMock name='from_pretrained' id='128159325380752'>
model = <app.model.ClinicalAssertionModel object at 0x748f6b108950>

    @pytest.mark.asyncio
    @patch("app.model.AutoTokenizer.from_pretrained")
    @patch("app.model.AutoModelForSequenceClassification.from_pretrained")
    @patch("app.model.TextClassificationPipeline")
    @patch("torch.cuda.is_available")
    async def test_load_model_success(
        self, mock_cuda, mock_pipeline, mock_model_class, mock_tokenizer, model
    ):
        """Test successful model loading"""
        mock_cuda.return_value = False
    
        # Mock the model and tokenizer
        mock_model_instance = Mock()
        mock_model_class.return_value = mock_model_instance
        mock_tokenizer_instance = Mock()
        mock_tokenizer.return_value = mock_tokenizer_instance
        mock_pipeline_instance = Mock()
        mock_pipeline.return_value = mock_pipeline_instance
    
        await model.load_model()
    
        assert model.tokenizer == mock_tokenizer_instance
>       assert model.model == mock_model_instance
E       AssertionError: assert <Mock name='from_pretrained().to().to()' id='128159327620368'> == <Mock name='from_pretrained()' id='128159325401024'>
E        +  where <Mock name='from_pretrained().to().to()' id='128159327620368'> = <app.model.ClinicalAssertionModel object at 0x748f6b108950>.model

tests/manual/test_model.py:82: AssertionError
_______________ TestClinicalAssertionModel.test_predict_success ________________

self = <manual.test_model.TestClinicalAssertionModel object at 0x748f6b7066f0>
mock_loop = <MagicMock name='get_event_loop' id='128159313019536'>
model = <app.model.ClinicalAssertionModel object at 0x748f6a53c0b0>

    @pytest.mark.asyncio
    @patch("asyncio.get_event_loop")
    async def test_predict_success(self, mock_loop, model):
        """Test successful prediction"""
        # Setup model as loaded
        model._loaded = True
        model.model = Mock()
        model.pipeline = Mock()
    
        # Mock the pipeline result
        mock_result = {"label": "LABEL_0", "score": 0.95}
        model.pipeline.return_value = [mock_result]
    
        # Mock asyncio loop
        mock_loop_instance = Mock()
        mock_loop.return_value = mock_loop_instance
        mock_loop_instance.run_in_executor = AsyncMock(return_value=mock_result)
    
        result = await model.predict("test sentence")
    
>       assert result == {"label": "PRESENT", "score": 0.95}
E       AssertionError: assert {'label': 'LA...'score': 0.95} == {'label': 'PR...'score': 0.95}
E         Omitting 1 identical items, use -vv to show
E         Differing items:
E         {'label': 'LABEL_0'} != {'label': 'PRESENT'}
E         Full diff:
E         - {'label': 'PRESENT', 'score': 0.95}
E         ?            ^^ ^^^^
E         + {'label': 'LABEL_0', 'score': 0.95}
E         ?            ^^^ ^^^

tests/manual/test_model.py:145: AssertionError
____________ TestClinicalAssertionModel.test_predict_batch_success _____________

self = <manual.test_model.TestClinicalAssertionModel object at 0x748f6b708da0>
mock_loop = <MagicMock name='get_event_loop' id='128159313523584'>
model = <app.model.ClinicalAssertionModel object at 0x748f6a5b71d0>

    @pytest.mark.asyncio
    @patch("asyncio.get_event_loop")
    async def test_predict_batch_success(self, mock_loop, model):
        """Test successful batch prediction"""
        # Setup model as loaded
        model._loaded = True
        model.model = Mock()
        model.pipeline = Mock()
    
        # Mock batch results
        mock_results = [
            [{"label": "LABEL_0", "score": 0.95}],
            [{"label": "LABEL_1", "score": 0.87}],
        ]
        model.pipeline.return_value = mock_results
    
        # Mock asyncio loop
        mock_loop_instance = Mock()
        mock_loop.return_value = mock_loop_instance
        mock_loop_instance.run_in_executor = AsyncMock(return_value=mock_results)
    
        result = await model.predict_batch(["sentence 1", "sentence 2"])
    
        expected = [
            {"label": "PRESENT", "score": 0.95},
            {"label": "ABSENT", "score": 0.87},
        ]
>       assert result == expected
E       AssertionError: assert [[{'label': '...core': 0.87}]] == [{'label': 'P...score': 0.87}]
E         At index 0 diff: [{'label': 'LABEL_0', 'score': 0.95}] != {'label': 'PRESENT', 'score': 0.95}
E         Full diff:
E         - [{'label': 'PRESENT', 'score': 0.95}, {'label': 'ABSENT', 'score': 0.87}]
E         ?             ^^ ^^^^                                - ^^
E         + [[{'label': 'LABEL_0', 'score': 0.95}], [{'label': 'LABEL_1', 'score': 0.87}]]
E         ? +            ^^^ ^^^                 +  +           +   ^^^                  +

tests/manual/test_model.py:237: AssertionError
=============================== warnings summary ===============================
venv/lib/python3.12/site-packages/transformers/utils/generic.py:441
  /home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/transformers/utils/generic.py:441: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
    _torch_pytree._register_pytree_node(

venv/lib/python3.12/site-packages/transformers/utils/generic.py:309
  /home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/transformers/utils/generic.py:309: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
    _torch_pytree._register_pytree_node(

tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key
  /home/sigmoid/TECH_DEMO/new-tech-demo/tests/manual/test_auth.py:140: RuntimeWarning: coroutine 'verify_api_key' was never awaited
    verify_api_key(mock_request, None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.12.3-final-0 -----------
Name                                                Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------
/home/sigmoid/test-repos/clinic/app/__init__.py         1      0      0      0   100%
/home/sigmoid/test-repos/clinic/app/auth.py            39     15     18      2    53%   42, 47-70
/home/sigmoid/test-repos/clinic/app/main.py           154     40     16      5    72%   73-100, 160, 176-178, 257, 277-278, 333-336, 358, 365, 432-437, 454-457, 536-542
/home/sigmoid/test-repos/clinic/app/middleware.py      92      1     14      0    99%   159
/home/sigmoid/test-repos/clinic/app/model.py           82      3     14      1    96%   45->48, 117-119
/home/sigmoid/test-repos/clinic/app/schemas.py         70      4     10      4    90%   37, 86, 90, 94
/home/sigmoid/test-repos/clinic/app/utils.py           49     10     12      3    79%   15-28, 39, 55, 104->108
-----------------------------------------------------------------------------------------------
TOTAL                                                 487     73     84     15    82%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_health_endpoint
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_no_keys_required
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_missing_from_request
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_invalid
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_bearer
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_header
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_query_param
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key
FAILED tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_with_exception
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_success
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_success
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_success
================== 12 failed, 76 passed, 3 warnings in 18.82s ==================
ðŸ“Š Coverage report generated
Name                                                Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------
/home/sigmoid/test-repos/clinic/app/__init__.py         1      0      0      0   100%
/home/sigmoid/test-repos/clinic/app/auth.py            39     15     18      2    53%   42, 47-70
/home/sigmoid/test-repos/clinic/app/main.py           157     42     18      6    71%   73-100, 160, 176-178, 257, 277-278, 333-336, 358, 365, 432-437, 454-457, 536-542, 558-559
/home/sigmoid/test-repos/clinic/app/middleware.py      92      1     14      0    99%   159
/home/sigmoid/test-repos/clinic/app/model.py           82      3     14      1    96%   45->48, 117-119
/home/sigmoid/test-repos/clinic/app/schemas.py         70      4     10      4    90%   37, 86, 90, 94
/home/sigmoid/test-repos/clinic/app/utils.py           49     10     12      3    79%   15-28, 39, 55, 104->108
-----------------------------------------------------------------------------------------------
TOTAL                                                 490     75     86     16    82%

âœ… Pytest completed for manual tests.

âœ… Manual Test Coverage: 85.01%

ðŸ“Š Coverage Summary:
  app/__init__.py: 100.0%
  app/auth.py: 61.5%
  app/main.py: 74.0%
  app/middleware.py: 98.9%
  app/model.py: 96.3%
  app/schemas.py: 94.3%
  app/utils.py: 79.6%

= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
COVERAGE ANALYSIS PHASE
= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
hello
ðŸ” Analyzing coverage gaps...
ðŸ” Analyzing coverage gaps...
================================================================================
COVERAGE GAP ANALYSIS REPORT
================================================================================

Overall Coverage: 85.01%
Total Statements: 487
Covered Statements: 414
Missing Statements: 73
AI Generation Needed: YES

FILES WITH COVERAGE GAPS:
--------------------------------------------------------------------------------

ðŸ“ app/auth.py
   Coverage: 61.54%
   Missing Lines: 15
   Uncovered: 42, 47, 49-50, 52-53, 55-56, 58-59, 63-66, 70

ðŸ“ app/main.py
   Coverage: 74.03%
   Missing Lines: 40
   Uncovered: 73-75, 77, 79-80, 83-84, 86-87, 89-91, 93, 96-97, 99-100, 160, 176, 178, 257, 277-278, 333-336, 358, 365, 432-433, 436-437, 454-455, 457, 536, 540, 542

ðŸ“ app/middleware.py
   Coverage: 98.91%
   Missing Lines: 1
   Uncovered: 159

ðŸ“ app/model.py
   Coverage: 96.34%
   Missing Lines: 3
   Uncovered: 117-119

ðŸ“ app/schemas.py
   Coverage: 94.29%
   Missing Lines: 4
   Uncovered: 37, 86, 90, 94

ðŸ“ app/utils.py
   Coverage: 79.59%
   Missing Lines: 10
   Uncovered: 15-18, 20, 26-28, 39, 55



================================================================================
âœ… Coverage gap analysis saved to: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json

âš ï¸  Coverage is below 90% (85.01%)
ðŸ¤– AI test generation recommended for uncovered code

âš ï¸  Coverage is below 90%
ðŸ¤– Initiating Gap-Based AI Test Generation...

= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
GAP-BASED AI TEST GENERATION (Using Full AI Workflow)
= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80

Warning: postprocess import failed: cannot import name 'extract_python_only' from 'src.gen.postprocess' (/home/sigmoid/TECH_DEMO/new-tech-demo/src/gen/postprocess.py); using fallbacks
ðŸŽ¯ Gap-focused mode enabled via --coverage-mode argument
Found 14 Python files in target directory
Project structure: Universal compatibility enabled
UNIVERSAL analysis for ANY PROJECT STRUCTURE in: /home/sigmoid/test-repos/clinic
Analyzing 8 Python files in project...
[framework_manager] Detection error in django: 'str' object has no attribute 'get'
[framework_manager] Framework(s) detected: ['fastapi', 'universal'] -> selected: fastapi
UNIVERSAL ANALYSIS COMPLETE:
   Files analyzed: 8
   Functions: 42 (top-level)
   Nested Functions: 23
   Classes: 28
   Methods: 23
   Routes: 8
   FastAPI Routes: 10
   Properties: 0
   Async functions: 39
   Imports tracked: 104
   Django models: 0
   Serializers: 0
   Views/ViewSets: 0
   Forms: 0
   Admin: 0
   Project packages: 2
   Detected Framework: fastapi
Starting UNIVERSAL test generation with gap-focused coverage mode...
UNIVERSAL test generation for ANY PROJECT STRUCTURE...

ðŸŽ¯ GAP-FOCUSED MODE: Analyzing coverage gaps...

================================================================================
GAP-FOCUSED MODE ACTIVE
================================================================================
Filtering analysis to target only uncovered code...
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6

ðŸŽ¯ Filtering analysis to focus on coverage gaps...

ðŸ“Š Gap-Focused Analysis Results:
   Original Functions: 42 â†’ Uncovered: 0
   Original Classes: 28 â†’ Uncovered: 0
   Original Methods: 23 â†’ Uncovered: 0
   Original Routes: 8 â†’ Uncovered: 8
   Total Reduction: 100.0% (focusing only on gaps)

âœ… Gap-focused analysis prepared
   Targeting 73 uncovered statements
================================================================================

âœ… Gap analysis complete: Targeting 0 uncovered functions, 0 uncovered classes, 0 uncovered methods
âœ… Successfully wrote: tests/generated/conftest.py
Created universal conftest: tests/generated/conftest.py
TESTGEN_FORCE environment variable: 'true'
ðŸš€ Force generation enabled - will regenerate all tests
Found 8 source files for force generation:
  - app/__init__.py
  - app/auth.py
  - app/main.py
  - app/middleware.py
  - app/model.py
  - app/schemas.py
  - app/utils.py
  - scripts/health-check.py
ðŸ§¹ Force mode: Cleaning up all existing generated tests
Cleaned up 0 existing test files
UNIVERSAL TARGET INCLUSION:
   Functions: 4 (including 4 nested)
   Classes: 0
   Methods: 0
   Routes: 18
   Project Packages: 2
Using universal targeting - all targets included
Analyzing required packages...
   auth: Local module (skipped pip install)
   middleware: Local module (skipped pip install)
   model: Local module (skipped pip install)
   schemas: Local module (skipped pip install)
   utils: Local module (skipped pip install)
Inferred 9 external packages: fastapi, httpx, prometheus_client, psutil, pydantic, starlette, torch, transformers, uvicorn
Installing 9 external packages...
Installing packages: fastapi, httpx, prometheus_client, psutil, pydantic, starlette, torch, transformers, uvicorn
   fastapi
   httpx
   prometheus_client
   psutil
   pydantic
   starlette
   torch
   transformers
   uvicorn
Successfully installed 9 packages.
UNIVERSAL COVERAGE TARGETS:
   Functions: 4
   Classes: 0
   Methods: 0
   Routes: 18
   Total Targets: 22
   Expected Coverage: Maximum
   Project Structure: Universal compatibility
Generating 1 UNIT test files for universal compatibility...
Generating unit test 1/1 for 4 targets
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
   ðŸ“Š Added 1691 chars of gap-focused context to prompt
âš ï¸ Syntax error in generated code for tests/generated/test_unit_20251114_075814_01.py: expected an indented block after 'if' statement on line 23 (<unknown>, line 26)
âœ… Fixed syntax errors in tests/generated/test_unit_20251114_075814_01.py
âœ… Successfully wrote: tests/generated/test_unit_20251114_075814_01.py
  test_unit_20251114_075814_01.py - 4 targets
Generating 1 INTEG test files for universal compatibility...
Generating integ test 1/1 for 18 targets
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
   ðŸ“Š Added 1691 chars of gap-focused context to prompt
âš ï¸ Syntax error in generated code for tests/generated/test_integ_20251114_075814_01.py: expected an indented block after 'if' statement on line 21 (<unknown>, line 24)
âœ… Fixed syntax errors in tests/generated/test_integ_20251114_075814_01.py
âœ… Successfully wrote: tests/generated/test_integ_20251114_075814_01.py
  test_integ_20251114_075814_01.py - 18 targets
Generating 1 E2E test files for universal compatibility...
Generating e2e test 1/1 for 18 targets
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
âœ… Loaded coverage gaps analysis from: /home/sigmoid/TECH_DEMO/new-tech-demo/coverage_gaps.json
   Current Coverage: 85.01%
   Uncovered Functions: 0
   Uncovered Classes: 0
   Files with Gaps: 6
   ðŸ“Š Added 1691 chars of gap-focused context to prompt
âš ï¸ Syntax error in generated code for tests/generated/test_e2e_20251114_075814_01.py: expected an indented block after 'if' statement on line 21 (<unknown>, line 24)
âœ… Fixed syntax errors in tests/generated/test_e2e_20251114_075814_01.py
âœ… Successfully wrote: tests/generated/test_e2e_20251114_075814_01.py
  test_e2e_20251114_075814_01.py - 18 targets
Updated test mapping for 8 source files
Generation completed: 3 test files for 8 source files
ðŸ“Š Updated test manifest: tests/generated/_manifest.json
UNIVERSAL GENERATION COMPLETE: 3 test files
Expected Coverage: Maximum with REAL IMPORTS
Universal Compatibility: ENABLED
Targets Covered: 22
Project Structure: 2 packages detected
UNIVERSAL TEST GENERATION SUCCESSFUL!
UNIVERSAL Results:
   Generated: 3 test files
   Coverage Mode: gap-focused
   Universal Compatibility: ENABLED
   Targets Covered: 101
   Project Structure: Universal handling enabled
Run UNIVERSAL Tests:
   Basic: python -m pytest ./tests/generated -v
   Coverage: python -m pytest ./tests/generated --cov=. --cov-report=html
   Universal: PYTHONPATH=/home/sigmoid/test-repos/clinic python -m pytest ./tests/generated
=== AI Test Generation Completed ===
ðŸ§© Total AI-generated test files: 3
./tests/generated/test_e2e_20251114_075814_01.py
./tests/generated/test_unit_20251114_075814_01.py
./tests/generated/test_integ_20251114_075814_01.py

âœ… Gap-based AI test generation completed successfully

= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
RUNNING COMBINED TESTS (Manual + AI Generated)
= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80

ðŸ“¦ Installing project dependencies...
ðŸ§ª Running combined test suite...
============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-7.4.3, pluggy-1.6.0 -- /home/sigmoid/TECH_DEMO/new-tech-demo/venv/bin/python3
cachedir: .pytest_cache
django: version: 5.2.8
metadata: {'Python': '3.12.3', 'Platform': 'Linux-6.14.0-33-generic-x86_64-with-glibc2.39', 'Packages': {'pytest': '7.4.3', 'pluggy': '1.6.0'}, 'Plugins': {'html': '4.1.1', 'django': '4.11.1', 'asyncio': '0.21.1', 'Faker': '12.0.1', 'mock': '3.15.1', 'anyio': '3.7.1', 'metadata': '3.1.1', 'cov': '4.1.0'}}
rootdir: /home/sigmoid/TECH_DEMO/new-tech-demo
configfile: pytest.ini
plugins: html-4.1.1, django-4.11.1, asyncio-0.21.1, Faker-12.0.1, mock-3.15.1, anyio-3.7.1, metadata-3.1.1, cov-4.1.0
asyncio: mode=Mode.AUTO
collecting ... collected 139 items

tests/generated/test_e2e_20251114_075814_01.py::test_service_status_contains_expected_fields PASSED [  0%]
tests/generated/test_e2e_20251114_075814_01.py::test_health_when_model_not_loaded_returns_503 PASSED [  1%]
tests/generated/test_e2e_20251114_075814_01.py::test_health_when_model_loaded_returns_healthresponse PASSED [  2%]
tests/generated/test_e2e_20251114_075814_01.py::test_metrics_endpoint_returns_prometheus_content FAILED [  2%]
tests/generated/test_e2e_20251114_075814_01.py::test_model_info_unavailable_and_available FAILED [  3%]
tests/generated/test_e2e_20251114_075814_01.py::test_predict_assertion_success_and_failure FAILED [  4%]
tests/generated/test_e2e_20251114_075814_01.py::test_predict_batch_success_and_over_limit FAILED [  5%]
tests/generated/test_e2e_20251114_075814_01.py::test_system_metrics_and_root_respect_model_loaded_flag FAILED [  5%]
tests/generated/test_e2e_20251114_075814_01.py::test_prediction_request_validation[Normal sentence-True] PASSED [  6%]
tests/generated/test_e2e_20251114_075814_01.py::test_prediction_request_validation[   trimmed   -True] PASSED [  7%]
tests/generated/test_e2e_20251114_075814_01.py::test_prediction_request_validation[-False] PASSED [  7%]
tests/generated/test_e2e_20251114_075814_01.py::test_prediction_request_validation[None-False] PASSED [  8%]
tests/generated/test_e2e_20251114_075814_01.py::test_batch_prediction_request_validation[sentences0-True] PASSED [  9%]
tests/generated/test_e2e_20251114_075814_01.py::test_batch_prediction_request_validation[sentences1-False] PASSED [ 10%]
tests/generated/test_e2e_20251114_075814_01.py::test_batch_prediction_request_validation[sentences2-False] PASSED [ 10%]
tests/generated/test_e2e_20251114_075814_01.py::test_batch_prediction_request_validation[None-False] PASSED [ 11%]
tests/generated/test_e2e_20251114_075814_01.py::test_verify_api_key_behavior_with_env PASSED [ 12%]
tests/generated/test_e2e_20251114_075814_01.py::test_verify_api_key_rejection_when_required PASSED [ 12%]
tests/generated/test_e2e_20251114_075814_01.py::test_http_exception_handler_increments_metrics_and_returns_payload PASSED [ 13%]
tests/generated/test_e2e_20251114_075814_01.py::test_general_exception_handler_catches_unexpected_errors FAILED [ 14%]
tests/generated/test_integ_20251114_075814_01.py::test_service_status_returns_expected_structure PASSED [ 15%]
tests/generated/test_integ_20251114_075814_01.py::test_health_check_raises_if_model_none FAILED [ 15%]
tests/generated/test_integ_20251114_075814_01.py::test_health_check_returns_healthy_when_model_loaded PASSED [ 16%]
tests/generated/test_integ_20251114_075814_01.py::test_health_check_unhealthy_when_model_not_ready PASSED [ 17%]
tests/generated/test_integ_20251114_075814_01.py::test_metrics_returns_prometheus_response PASSED [ 17%]
tests/generated/test_integ_20251114_075814_01.py::test_model_info_raises_when_model_missing PASSED [ 18%]
tests/generated/test_integ_20251114_075814_01.py::test_model_info_returns_model_info_when_loaded FAILED [ 19%]
tests/generated/test_integ_20251114_075814_01.py::test_predict_assertion_raises_if_model_not_loaded PASSED [ 20%]
tests/generated/test_integ_20251114_075814_01.py::test_predict_assertion_successful_flow PASSED [ 20%]
tests/generated/test_integ_20251114_075814_01.py::test_predict_batch_raises_when_model_not_loaded PASSED [ 21%]
tests/generated/test_integ_20251114_075814_01.py::test_predict_batch_rejects_oversized_batch PASSED [ 22%]
tests/generated/test_integ_20251114_075814_01.py::test_predict_batch_successful_flow PASSED [ 23%]
tests/generated/test_integ_20251114_075814_01.py::test_system_metrics_model_state_boolean PASSED [ 23%]
tests/generated/test_integ_20251114_075814_01.py::test_root_status_reflects_model_state PASSED [ 24%]
tests/generated/test_integ_20251114_075814_01.py::test_validate_sentence_accepts_and_rejects_inputs SKIPPED [ 25%]
tests/generated/test_integ_20251114_075814_01.py::test_validate_sentences_handles_edge_cases SKIPPED [ 25%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentence_various_inputs[Normal clinical sentence.-True] SKIPPED [ 26%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentence_various_inputs[-False] SKIPPED [ 27%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentence_various_inputs[None-False] SKIPPED [ 28%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentence_various_inputs[   \t\n-False] SKIPPED [ 28%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentence_various_inputs[12345-True] SKIPPED [ 29%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentences_various_inputs[sentences0-False] SKIPPED [ 30%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentences_various_inputs[sentences1-True] SKIPPED [ 30%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentences_various_inputs[sentences2-True] SKIPPED [ 31%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentences_various_inputs[sentences3-True] SKIPPED [ 32%]
tests/generated/test_unit_20251114_075814_01.py::test_validate_sentences_various_inputs[sentences4-False] SKIPPED [ 33%]
tests/generated/test_unit_20251114_075814_01.py::test_predict_batch_method_execution[sentences0] PASSED [ 33%]
tests/generated/test_unit_20251114_075814_01.py::test_predict_batch_method_execution[sentences1] PASSED [ 34%]
tests/generated/test_unit_20251114_075814_01.py::test_predict_batch_method_execution[sentences2] PASSED [ 35%]
tests/generated/test_unit_20251114_075814_01.py::test_dispatch_method_success_and_exception FAILED [ 35%]
tests/generated/test_unit_20251114_075814_01.py::test_sanity_imports_and_utils PASSED [ 36%]
tests/manual/test_api.py::TestHealthEndpoint::test_health_check_success PASSED [ 37%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_success PASSED [ 38%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_empty_sentence PASSED [ 38%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[The patient denies chest pain.] PASSED [ 39%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[He has a history of hypertension.] PASSED [ 40%]
tests/manual/test_api.py::TestPredictionEndpoint::test_predict_various_sentences[No signs of pneumonia were observed.] PASSED [ 41%]
tests/manual/test_api.py::TestBatchPredictionEndpoint::test_batch_predict_success PASSED [ 41%]
tests/manual/test_api.py::TestBatchPredictionEndpoint::test_batch_predict_empty_list PASSED [ 42%]
tests/manual/test_api.py::TestRootEndpoint::test_root_endpoint PASSED    [ 43%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_conditional PASSED [ 43%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_uncertainty PASSED [ 44%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_no_rule PASSED [ 45%]
tests/manual/test_api.py::TestHybridPipeline::test_apply_hybrid_pipeline_multiple_sentences PASSED [ 46%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_conditional_phrases_positive PASSED [ 46%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_conditional_phrases_negative PASSED [ 47%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_uncertainty_phrases_positive PASSED [ 48%]
tests/manual/test_api.py::TestUtilityFunctions::test_detect_uncertainty_phrases_negative PASSED [ 48%]
tests/manual/test_api.py::TestEnhancedPredictionEndpoints::test_predict_with_hybrid_pipeline PASSED [ 49%]
tests/manual/test_api.py::TestEnhancedPredictionEndpoints::test_batch_predict_with_hybrid_pipeline PASSED [ 50%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_no_api_keys PASSED  [ 51%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_with_api_keys PASSED [ 51%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_init_with_whitespace_api_keys PASSED [ 52%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_no_keys_required PASSED [ 53%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_valid PASSED  [ 53%]
tests/manual/test_auth.py::TestAPIKeyAuth::test_verify_key_invalid PASSED [ 54%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_health_endpoint PASSED [ 55%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_root_endpoint PASSED [ 56%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_metrics_endpoint PASSED [ 56%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_no_keys_required FAILED [ 57%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_missing_from_request FAILED [ 58%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_invalid FAILED [ 58%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_bearer FAILED [ 59%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_header FAILED [ 60%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_query_param FAILED [ 61%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key FAILED [ 61%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_multiple_keys PASSED [ 62%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_empty_key_string PASSED [ 63%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_whitespace_only PASSED [ 64%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_special_characters PASSED [ 64%]
tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_case_sensitive PASSED [ 65%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_init PASSED [ 66%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_init_with_csp PASSED [ 66%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_dispatch_no_csp_http PASSED [ 67%]
tests/manual/test_middleware.py::TestSecurityHeadersMiddleware::test_dispatch_with_csp_https PASSED [ 68%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_init PASSED [ 69%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_with_x_forwarded_for PASSED [ 69%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_with_client PASSED [ 70%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_get_client_id_unknown PASSED [ 71%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_health_endpoint PASSED [ 71%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_under_limit PASSED [ 72%]
tests/manual/test_middleware.py::TestRateLimitMiddleware::test_dispatch_over_limit PASSED [ 73%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_init PASSED [ 74%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_with_x_forwarded_for PASSED [ 74%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_with_client PASSED [ 75%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_get_client_id_unknown PASSED [ 76%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_success PASSED [ 76%]
tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_with_exception FAILED [ 77%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_init PASSED [ 78%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_success PASSED [ 79%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_error PASSED [ 79%]
tests/manual/test_middleware.py::TestMetricsMiddleware::test_dispatch_exception PASSED [ 80%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_init PASSED [ 81%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_not_loaded PASSED [ 82%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_after_init PASSED [ 82%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_is_loaded_no_model PASSED [ 83%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_device_cuda_available PASSED [ 84%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_device_cuda_not_available PASSED [ 84%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_success FAILED [ 85%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_tokenizer_failure PASSED [ 86%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_model_failure PASSED [ 87%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_not_loaded PASSED [ 87%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_not_loaded PASSED [ 88%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_success FAILED [ 89%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_pipeline_error PASSED [ 89%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_success PASSED [ 90%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_list_result PASSED [ 91%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_nested_list_result PASSED [ 92%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_unexpected_result_type PASSED [ 92%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_success FAILED [ 93%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_success PASSED [ 94%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_single_result PASSED [ 94%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_get_model_info PASSED [ 95%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_get_model_info_cuda_available PASSED [ 96%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_empty_result PASSED [ 97%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_none_result PASSED [ 97%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_empty_results PASSED [ 98%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_sync_mixed_result_types PASSED [ 99%]
tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_sync_unknown_label PASSED [100%]

=================================== FAILURES ===================================
_______________ test_metrics_endpoint_returns_prometheus_content _______________

    def test_metrics_endpoint_returns_prometheus_content():
        """UNIVERSAL test for maximum coverage."""
        """
        GET /metrics should return bytes appropriate for Prometheus content.
        """
        client = make_client()
        resp = client.get("/metrics")
        assert resp.status_code == 200
        # CONTENT_TYPE_LATEST from prometheus_client is the canonical header
>       assert resp.headers.get("content-type") in (app_main.CONTENT_TYPE_LATEST, "text/plain; version=0.0.4; charset=utf-8")
E       assert 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8' in ('text/plain; version=0.0.4; charset=utf-8', 'text/plain; version=0.0.4; charset=utf-8')
E        +  where 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8' = <bound method Headers.get of Headers({'content-type': 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8', 'x-content-type-options': 'nosniff', 'x-frame-options': 'DENY', 'x-xss-protection': '1; mode=block', 'referrer-policy': 'strict-origin-when-cross-origin', 'content-security-policy': "default-src 'self' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https://fastapi.tiangolo.com", 'content-encoding': 'gzip', 'vary': 'Accept-Encoding', 'x-request-id': 'req-1763107403828', 'x-response-time': '0.006s'})>('content-type')
E        +    where <bound method Headers.get of Headers({'content-type': 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8', 'x-content-type-options': 'nosniff', 'x-frame-options': 'DENY', 'x-xss-protection': '1; mode=block', 'referrer-policy': 'strict-origin-when-cross-origin', 'content-security-policy': "default-src 'self' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https://fastapi.tiangolo.com", 'content-encoding': 'gzip', 'vary': 'Accept-Encoding', 'x-request-id': 'req-1763107403828', 'x-response-time': '0.006s'})> = Headers({'content-type': 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8', 'x-content-type-options': 'nosniff', 'x-frame-options': 'DENY', 'x-xss-protection': '1; mode=block', 'referrer-policy': 'strict-origin-when-cross-origin', 'content-security-policy': "default-src 'self' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https://fastapi.tiangolo.com", 'content-encoding': 'gzip', 'vary': 'Accept-Encoding', 'x-request-id': 'req-1763107403828', 'x-response-time': '0.006s'}).get
E        +      where Headers({'content-type': 'text/plain; version=0.0.4; charset=utf-8; charset=utf-8', 'x-content-type-options': 'nosniff', 'x-frame-options': 'DENY', 'x-xss-protection': '1; mode=block', 'referrer-policy': 'strict-origin-when-cross-origin', 'content-security-policy': "default-src 'self' https://cdn.jsdelivr.net https://fastapi.tiangolo.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https://fastapi.tiangolo.com", 'content-encoding': 'gzip', 'vary': 'Accept-Encoding', 'x-request-id': 'req-1763107403828', 'x-response-time': '0.006s'}) = <Response [200 OK]>.headers

tests/generated/test_e2e_20251114_075814_01.py:215: AssertionError
__________________ test_model_info_unavailable_and_available ___________________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfcca59cd0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x78dfcca6d940>

    def test_model_info_unavailable_and_available(monkeypatch):
        """UNIVERSAL test for maximum coverage."""
        """
        Test /model/info when model is not loaded -> 503, and when loaded -> returns model info.
        """
        client = make_client()
        # Model not loaded
        app_main.model = None
        resp = client.get("/model/info")
        assert resp.status_code == 503
    
        # Model loaded
        dummy = DummyModel(loaded=True)
        app_main.model = dummy
>       resp = client.get("/model/info")

tests/generated/test_e2e_20251114_075814_01.py:233: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 4 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107404033", "error": "4 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.35040283203125, "timestamp": 1763107404.0348704}
ERROR    app.main:main.py:540 Unhandled exception: 4 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 4 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'dummy-model', '..., 'ABSENT', 'POSSIBLE']}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
__________________ test_predict_assertion_success_and_failure __________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x78dfcca4c4d0>

    def test_predict_assertion_success_and_failure(monkeypatch):
        """UNIVERSAL test for maximum coverage."""
        """
        - When model isn't loaded, POST /predict returns 503.
        - When model is loaded, POST /predict processes and returns PredictionResponse.
        - When model.predict raises, endpoint returns 500.
        """
        client = make_client()
    
        # Not loaded -> 503
        app_main.model = None
        resp = client.post("/predict", json={"sentence": "Sample text"})
        assert resp.status_code == 503
    
        # Loaded and successful
        dummy = DummyModel(loaded=True)
        app_main.model = dummy
    
        # Patch sanitize_clinical_text and apply_hybrid_pipeline to ensure deterministic output
        monkeypatch.setattr(app_utils, "sanitize_clinical_text", lambda s: s.strip() if isinstance(s, str) else "")
        def fake_hybrid(model_results, sentences):
            # return a sentinelled structure expected by the main code
            res = model_results[0].copy()
            res["label"] = "PRESENT"
            res["model_label"] = model_results[0].get("model_label", "present")
            res["score"] = float(model_results[0].get("score", 0.0))
            return [res]
        monkeypatch.setattr(app_utils, "apply_hybrid_pipeline", fake_hybrid)
    
        resp = client.post("/predict", json={"sentence": "  Patient has fever  "})
        assert resp.status_code == 200, resp.text
        data = resp.json()
        # Fields returned by PredictionResponse
        assert data["label"] == "PRESENT"
>       assert data["model_label"] == "present"
E       AssertionError: assert 'PRESENT' == 'present'
E         - present
E         + PRESENT

tests/generated/test_e2e_20251114_075814_01.py:274: AssertionError
__________________ test_predict_batch_success_and_over_limit ___________________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x78dfcd435c10>

    def test_predict_batch_success_and_over_limit(monkeypatch):
        """UNIVERSAL test for maximum coverage."""
        """
        - When model isn't loaded, /predict/batch should return 503.
        - When batch size exceeds MAX_BATCH_SIZE -> 400.
        - When valid, returns BatchPredictionResponse with correct aggregation.
        """
        client = make_client()
    
        # Model not loaded -> 503
        app_main.model = None
        resp = client.post("/predict/batch", json={"sentences": ["a", "b"]})
        assert resp.status_code == 503
    
        # Set MAX_BATCH_SIZE small to test over-limit branch
        monkeypatch.setenv("MAX_BATCH_SIZE", "1")
        dummy = DummyModel(loaded=True)
        app_main.model = dummy
        resp = client.post("/predict/batch", json={"sentences": ["one", "two"]})
        assert resp.status_code == 400
        assert "Batch size cannot exceed" in resp.json().get("detail", "") or "cannot exceed" in resp.text
    
        # Set MAX_BATCH_SIZE larger and test happy path
        monkeypatch.setenv("MAX_BATCH_SIZE", "10")
        monkeypatch.setattr(app_utils, "sanitize_clinical_text", lambda s: s.strip() if isinstance(s, str) else "")
        def fake_batch_hybrid(model_results, sentences):
            # Return a matching list of results
            out = []
            for mr in model_results:
                r = mr.copy()
                r["label"] = "ABSENT"
                out.append(r)
            return out
        monkeypatch.setattr(app_utils, "apply_hybrid_pipeline", fake_batch_hybrid)
    
        app_main.model = DummyModel(loaded=True)
        resp = client.post("/predict/batch", json={"sentences": ["s1", "s2", "s3"]})
        assert resp.status_code == 200, resp.text
        data = resp.json()
        assert data["batch_size"] == 3
        assert "predictions" in data and isinstance(data["predictions"], list)
>       assert data["predictions"][0]["label"] == "ABSENT"
E       AssertionError: assert 'PRESENT' == 'ABSENT'
E         - ABSENT
E         + PRESENT

tests/generated/test_e2e_20251114_075814_01.py:328: AssertionError
____________ test_system_metrics_and_root_respect_model_loaded_flag ____________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x78dfcd4345f0>

    def test_system_metrics_and_root_respect_model_loaded_flag(monkeypatch):
        """UNIVERSAL test for maximum coverage."""
        """
        Test /system/metrics and root endpoint behaviors depending on model loaded state.
        """
        client = make_client()
        # Patch system metrics
        monkeypatch.setattr(app_utils, "get_system_metrics", lambda: {"memory_mb": 50, "cpu_percent": 1.2})
    
        # No model -> model_loaded False
        app_main.model = None
        resp = client.get("/system/metrics")
        assert resp.status_code == 200
        data = resp.json()
        assert data["model_loaded"] is False
>       assert data["memory_usage_mb"] == 50
E       assert 5986.2109375 == 50

tests/generated/test_e2e_20251114_075814_01.py:346: AssertionError
___________ test_general_exception_handler_catches_unexpected_errors ___________

monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x78dfcc61cdd0>

    def test_general_exception_handler_catches_unexpected_errors(monkeypatch):
        """UNIVERSAL test for maximum coverage."""
        """
        Force an unhandled exception inside a route to ensure the general exception handler returns HTTP 500 structure.
        We'll monkeypatch an endpoint helper (e.g., get_system_metrics) to raise and call /system/metrics.
        """
        monkeypatch.setattr(app_utils, "get_system_metrics", lambda: (_ for _ in ()).throw(RuntimeError("boom")))
        client = make_client()
        resp = client.get("/system/metrics")
        # general_exception_handler should return 500 when an unexpected exception is raised
>       assert resp.status_code == 500
E       assert 200 == 500
E        +  where 200 = <Response [200 OK]>.status_code

tests/generated/test_e2e_20251114_075814_01.py:500: AssertionError
____________________ test_health_check_raises_if_model_none ____________________

    def test_health_check_raises_if_model_none():
        """UNIVERSAL test for maximum coverage."""
        # Ensure model is None to simulate startup not completed
        main.model = None
        with pytest.raises(HTTPException) as exc:
            run(main.health_check())
        assert exc.value.status_code == 503
>       assert "Model not loaded" in str(exc.value.detail) or "Model not loaded" in exc.value.detail
E       AssertionError: assert ('Model not loaded' in 'Health check failed: ' or 'Model not loaded' in 'Health check failed: ')
E        +  where 'Health check failed: ' = str('Health check failed: ')
E        +    where 'Health check failed: ' = HTTPException(status_code=503, detail='Health check failed: ').detail
E        +      where HTTPException(status_code=503, detail='Health check failed: ') = <ExceptionInfo HTTPException(status_code=503, detail='Health check failed: ') tblen=4>.value
E        +  and   'Health check failed: ' = HTTPException(status_code=503, detail='Health check failed: ').detail
E        +    where HTTPException(status_code=503, detail='Health check failed: ') = <ExceptionInfo HTTPException(status_code=503, detail='Health check failed: ') tblen=4>.value

tests/generated/test_integ_20251114_075814_01.py:113: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    app.main:main.py:229 Health check failed:
________________ test_model_info_returns_model_info_when_loaded ________________

    def test_model_info_returns_model_info_when_loaded():
        """UNIVERSAL test for maximum coverage."""
        stub = StubModel(loaded=True, info={"name": "x", "version": "v"})
        main.model = stub
>       info = run(main.model_info())

tests/generated/test_integ_20251114_075814_01.py:173: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
tests/generated/test_integ_20251114_075814_01.py:88: in run
    return asyncio.get_event_loop().run_until_complete(coro)
/usr/lib/python3.12/asyncio/base_events.py:687: in run_until_complete
    return future.result()
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'x', 'version': 'v'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'x', 'version': 'v'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'x', 'version': 'v'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'x', 'version': 'v'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'x', 'version': 'v'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
__________________ test_dispatch_method_success_and_exception __________________

    @pytest.mark.asyncio
    async def test_dispatch_method_success_and_exception():
        """UNIVERSAL test for maximum coverage."""
        """
        Find and invoke 'dispatch' method from app.middleware.
        We test both:
         - successful path: call_next returns a Response-like object
         - exception path: call_next raises an exception and dispatch should return a JSONResponse-like object
        """
        mw_mod = safe_import("app.middleware")
    
        # Discover dispatch function and owner (class) if nested
        try:
            owner, func = discover_method_owner_and_func(mw_mod, "dispatch")
        except AttributeError:
            pytest.skip("dispatch not found in app.middleware")
    
        # Build a minimal 'self' stub with likely attributes used
        class StubMiddleware:
            def __init__(self):
                self.logger = Mock()
                # metrics or counters if referenced
                self._internal = {}
    
        stub = StubMiddleware()
    
        # Simple request stub with attributes expected by middleware
        class URLObj:
            def __init__(self, path):
                self.path = path
    
            def __str__(self):
                return self.path
    
        request = SimpleNamespace()
        request.method = "GET"
        request.url = URLObj("/test-path")
        request.scope = {"type": "http", "method": "GET", "path": "/test-path"}
    
        # Prepare a call_next that returns a simple Response-like object
        class SimpleResponse:
            def __init__(self):
                self.status_code = 200
                self.headers = {"content-type": "application/json"}
                self.body = b'{"ok": true}'
    
            async def __call__(self, *args, **kwargs):
                return self
    
        async def call_next_success(req):
            return SimpleResponse()
    
        async def call_next_error(req):
            raise RuntimeError("downstream error")
    
        # Call the dispatch function for success path
        if inspect.iscoroutinefunction(func):
            bound = func.__get__(stub, stub.__class__)
>           resp = await bound(request, call_next_success)

tests/generated/test_unit_20251114_075814_01.py:358: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <test_unit_20251114_075814_01.test_dispatch_method_success_and_exception.<locals>.StubMiddleware object at 0x78dfcc94aba0>
request = namespace(method='GET', url=<test_unit_20251114_075814_01.test_dispatch_method_success_and_exception.<locals>.URLObj object at 0x78dfcc948170>, scope={'type': 'http', 'method': 'GET', 'path': '/test-path'})
call_next = <function test_dispatch_method_success_and_exception.<locals>.call_next_success at 0x78dfc7cc4f40>

    async def dispatch(
        self, request: Request, call_next: RequestResponseEndpoint
    ) -> Response:
>       raise NotImplementedError()  # pragma: no cover
E       NotImplementedError

venv/lib/python3.12/site-packages/starlette/middleware/base.py:115: NotImplementedError
____________ TestVerifyAPIKey.test_verify_api_key_no_keys_required _____________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfcc984fb0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097316c60>
auth_client = <starlette.testclient.TestClient object at 0x78dfcc5be480>

    def test_verify_api_key_no_keys_required(self, auth_client):
        """Test endpoints when no API keys are required"""
        with patch.dict(os.environ, {"API_KEYS": "", "REQUIRE_API_KEY": "false"}):
>           response = auth_client.get("/model/info")

tests/manual/test_auth.py:70: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107417536", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.5816688537597656, "timestamp": 1763107417.5380611}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
__________ TestVerifyAPIKey.test_verify_api_key_missing_from_request ___________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfcc1a4230>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097316ff0>
auth_client = <starlette.testclient.TestClient object at 0x78dfcc19e360>

    def test_verify_api_key_missing_from_request(self, auth_client):
        """Test API key verification when key is missing"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
>           response = auth_client.get("/model/info")

tests/manual/test_auth.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107418407", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.2831687927246094, "timestamp": 1763107418.4091415}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
_________________ TestVerifyAPIKey.test_verify_api_key_invalid _________________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfcc9878c0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097317380>
auth_client = <starlette.testclient.TestClient object at 0x78dfc7cdbf80>

    def test_verify_api_key_invalid(self, auth_client):
        """Test API key verification with invalid key"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
>           response = auth_client.get(
                "/model/info", headers={"Authorization": "Bearer invalid_key"}
            )

tests/manual/test_auth.py:88: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107419291", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.2471675872802734, "timestamp": 1763107419.292802}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
______________ TestVerifyAPIKey.test_verify_api_key_valid_bearer _______________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfcc1d5190>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097317710>
auth_client = <starlette.testclient.TestClient object at 0x78dfcc9859d0>

    def test_verify_api_key_valid_bearer(self, auth_client):
        """Test API key verification with valid Bearer token"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
>           response = auth_client.get(
                "/model/info", headers={"Authorization": "Bearer test_key"}
            )

tests/manual/test_auth.py:100: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107420286", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.270294189453125, "timestamp": 1763107420.2882888}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
______________ TestVerifyAPIKey.test_verify_api_key_valid_header _______________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfc7c9ff50>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097317aa0>
auth_client = <starlette.testclient.TestClient object at 0x78dfcc987c20>

    def test_verify_api_key_valid_header(self, auth_client):
        """Test API key verification with valid X-API-Key header"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
>           response = auth_client.get("/model/info", headers={"X-API-Key": "test_key"})

tests/manual/test_auth.py:110: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107421232", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.638174057006836, "timestamp": 1763107421.2345717}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
____________ TestVerifyAPIKey.test_verify_api_key_valid_query_param ____________

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
>           return self.receive_nowait()

venv/lib/python3.12/site-packages/anyio/streams/memory.py:98: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    def receive_nowait(self) -> T_co:
        """
        Receive the next item if it can be done without waiting.
    
        :return: the received item
        :raises ~anyio.ClosedResourceError: if this send stream has been closed
        :raises ~anyio.EndOfStream: if the buffer is empty and this stream has been
            closed from the sending end
        :raises ~anyio.WouldBlock: if there are no items in the buffer and no tasks
            waiting to send
    
        """
        if self._closed:
            raise ClosedResourceError
    
        if self._state.waiting_senders:
            # Get the item from the next sender
            send_event, item = self._state.waiting_senders.popitem(last=False)
            self._state.buffer.append(item)
            send_event.set()
    
        if self._state.buffer:
            return self._state.buffer.popleft()
        elif not self._state.open_send_channels:
            raise EndOfStream
    
>       raise WouldBlock
E       anyio.WouldBlock

venv/lib/python3.12/site-packages/anyio/streams/memory.py:93: WouldBlock

During handling of the above exception, another exception occurred:

request = <starlette.requests.Request object at 0x78dfc7c36ed0>

    async def call_next(request: Request) -> Response:
        app_exc: typing.Optional[Exception] = None
        send_stream, recv_stream = anyio.create_memory_object_stream()
    
        async def receive_or_disconnect() -> Message:
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            async with anyio.create_task_group() as task_group:
    
                async def wrap(func: typing.Callable[[], typing.Awaitable[T]]) -> T:
                    result = await func()
                    task_group.cancel_scope.cancel()
                    return result
    
                task_group.start_soon(wrap, response_sent.wait)
                message = await wrap(request.receive)
    
            if response_sent.is_set():
                return {"type": "http.disconnect"}
    
            return message
    
        async def close_recv_stream_on_response_sent() -> None:
            await response_sent.wait()
            recv_stream.close()
    
        async def send_no_error(message: Message) -> None:
            try:
                await send_stream.send(message)
            except anyio.BrokenResourceError:
                # recv_stream has been closed, i.e. response_sent has been set.
                return
    
        async def coro() -> None:
            nonlocal app_exc
    
            async with send_stream:
                try:
                    await self.app(scope, receive_or_disconnect, send_no_error)
                except Exception as exc:
                    app_exc = exc
    
        task_group.start_soon(close_recv_stream_on_response_sent)
        task_group.start_soon(coro)
    
        try:
>           message = await recv_stream.receive()

venv/lib/python3.12/site-packages/starlette/middleware/base.py:78: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = MemoryObjectReceiveStream(_state=MemoryObjectStreamState(max_buffer_size=0, buffer=deque([]), open_send_channels=0, open_receive_channels=1, waiting_receivers=OrderedDict(), waiting_senders=OrderedDict()), _closed=False)

    async def receive(self) -> T_co:
        await checkpoint()
        try:
            return self.receive_nowait()
        except WouldBlock:
            # Add ourselves in the queue
            receive_event = Event()
            container: list[T_co] = []
            self._state.waiting_receivers[receive_event] = container
    
            try:
                await receive_event.wait()
            except get_cancelled_exc_class():
                # Ignore the immediate cancellation if we already received an item, so as not to
                # lose it
                if not container:
                    raise
            finally:
                self._state.waiting_receivers.pop(receive_event, None)
    
            if container:
                return container[0]
            else:
>               raise EndOfStream
E               anyio.EndOfStream

venv/lib/python3.12/site-packages/anyio/streams/memory.py:118: EndOfStream

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097130200>
auth_client = <starlette.testclient.TestClient object at 0x78dfc7c36480>

    def test_verify_api_key_valid_query_param(self, auth_client):
        """Test API key verification with valid query parameter"""
        with patch.dict(
            os.environ, {"API_KEYS": "test_key", "REQUIRE_API_KEY": "true"}
        ):
>           response = auth_client.get("/model/info?api_key=test_key")

tests/manual/test_auth.py:118: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
venv/lib/python3.12/site-packages/starlette/testclient.py:499: in get
    return super().get(
venv/lib/python3.12/site-packages/httpx/_client.py:1041: in get
    return self.request(
venv/lib/python3.12/site-packages/starlette/testclient.py:465: in request
    return super().request(
venv/lib/python3.12/site-packages/httpx/_client.py:814: in request
    return self.send(request, auth=auth, follow_redirects=follow_redirects)
venv/lib/python3.12/site-packages/httpx/_client.py:901: in send
    response = self._send_handling_auth(
venv/lib/python3.12/site-packages/httpx/_client.py:929: in _send_handling_auth
    response = self._send_handling_redirects(
venv/lib/python3.12/site-packages/httpx/_client.py:966: in _send_handling_redirects
    response = self._send_single_request(request)
venv/lib/python3.12/site-packages/httpx/_client.py:1002: in _send_single_request
    response = transport.handle_request(request)
venv/lib/python3.12/site-packages/starlette/testclient.py:342: in handle_request
    raise exc
venv/lib/python3.12/site-packages/starlette/testclient.py:339: in handle_request
    portal.call(self.app, scope, receive, send)
venv/lib/python3.12/site-packages/anyio/from_thread.py:277: in call
    return cast(T_Retval, self.start_task_soon(func, *args).result())
/usr/lib/python3.12/concurrent/futures/_base.py:456: in result
    return self.__get_result()
/usr/lib/python3.12/concurrent/futures/_base.py:401: in __get_result
    raise self._exception
venv/lib/python3.12/site-packages/anyio/from_thread.py:217: in _call_func
    retval = await retval
venv/lib/python3.12/site-packages/fastapi/applications.py:1106: in __call__
    await super().__call__(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/applications.py:122: in __call__
    await self.middleware_stack(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:184: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/errors.py:162: in __call__
    await self.app(scope, receive, _send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:176: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:128: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:24: in __call__
    await responder(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/gzip.py:44: in __call__
    await self.app(scope, receive, self.send_with_gzip)
venv/lib/python3.12/site-packages/starlette/middleware/cors.py:83: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py:34: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:108: in __call__
    response = await self.dispatch_func(request, call_next)
../../test-repos/clinic/app/middleware.py:30: in dispatch
    response = await call_next(request)
venv/lib/python3.12/site-packages/starlette/middleware/base.py:84: in call_next
    raise app_exc
venv/lib/python3.12/site-packages/starlette/middleware/base.py:70: in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:79: in __call__
    raise exc
venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py:68: in __call__
    await self.app(scope, receive, sender)
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:20: in __call__
    raise e
venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py:17: in __call__
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:718: in __call__
    await route.handle(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:276: in handle
    await self.app(scope, receive, send)
venv/lib/python3.12/site-packages/starlette/routing.py:66: in app
    response = await func(request)
venv/lib/python3.12/site-packages/fastapi/routing.py:274: in app
    raw_response = await run_endpoint_function(
venv/lib/python3.12/site-packages/fastapi/routing.py:191: in run_endpoint_function
    return await dependant.call(**values)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    @app.get(
        "/model/info",
        response_model=ModelInfoResponse,
        tags=["Model"],
        dependencies=[Depends(verify_api_key)] if os.getenv("REQUIRE_API_KEY") else [],
    )
    async def model_info() -> ModelInfoResponse:
        """Get detailed model information"""
        if not model or not model.is_loaded():
            raise HTTPException(
                status_code=status.HTTP_503_SERVICE_UNAVAILABLE, detail="Model not loaded"
            )
    
>       return ModelInfoResponse(**model.get_model_info())
E       pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
E       model_name
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       device
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       loaded
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       labels
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing
E       cuda_available
E         Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
E           For further information visit https://errors.pydantic.dev/2.5/v/missing

../../test-repos/clinic/app/main.py:257: ValidationError
------------------------------ Captured log call -------------------------------
ERROR    app.middleware:middleware.py:148 {"event": "request_failed", "request_id": "req-1763107422091", "error": "5 validation errors for ModelInfoResponse\nmodel_name\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ndevice\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nloaded\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\nlabels\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing\ncuda_available\n  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]\n    For further information visit https://errors.pydantic.dev/2.5/v/missing", "duration_ms": 1.4295578002929688, "timestamp": 1763107422.0929089}
ERROR    app.main:main.py:540 Unhandled exception: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 98, in receive
    return self.receive_nowait()
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 93, in receive_nowait
    raise WouldBlock
anyio.WouldBlock

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 78, in call_next
    message = await recv_stream.receive()
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/anyio/streams/memory.py", line 118, in receive
    raise EndOfStream
anyio.EndOfStream

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 162, in __call__
    await self.app(scope, receive, _send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 176, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 128, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 24, in __call__
    await responder(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/gzip.py", line 44, in __call__
    await self.app(scope, receive, self.send_with_gzip)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/cors.py", line 83, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/trustedhost.py", line 34, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 108, in __call__
    response = await self.dispatch_func(request, call_next)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/middleware.py", line 30, in dispatch
    response = await call_next(request)
               ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 84, in call_next
    raise app_exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 70, in coro
    await self.app(scope, receive_or_disconnect, send_no_error)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 79, in __call__
    raise exc
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py", line 68, in __call__
    await self.app(scope, receive, sender)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 20, in __call__
    raise e
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/middleware/asyncexitstack.py", line 17, in __call__
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 718, in __call__
    await route.handle(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 276, in handle
    await self.app(scope, receive, send)
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/starlette/routing.py", line 66, in app
    response = await func(request)
               ^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 274, in app
    raw_response = await run_endpoint_function(
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/fastapi/routing.py", line 191, in run_endpoint_function
    return await dependant.call(**values)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/test-repos/clinic/app/main.py", line 257, in model_info
    return ModelInfoResponse(**model.get_model_info())
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/pydantic/main.py", line 164, in __init__
    __pydantic_self__.__pydantic_validator__.validate_python(data, self_instance=__pydantic_self__)
pydantic_core._pydantic_core.ValidationError: 5 validation errors for ModelInfoResponse
model_name
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
device
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
loaded
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
labels
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
cuda_available
  Field required [type=missing, input_value={'name': 'stub-model', 'version': '0.0.1'}, input_type=dict]
    For further information visit https://errors.pydantic.dev/2.5/v/missing
___________ TestVerifyAPIKey.test_verify_api_key_logging_invalid_key ___________

self = <MagicMock name='logger.warning' id='132902597514672'>

    def assert_called(self):
        """assert that the mock was called at least once
        """
        if self.call_count == 0:
            msg = ("Expected '%s' to have been called." %
                   (self._mock_name or 'mock'))
>           raise AssertionError(msg)
E           AssertionError: Expected 'warning' to have been called.

/usr/lib/python3.12/unittest/mock.py:913: AssertionError

During handling of the above exception, another exception occurred:

self = <manual.test_auth.TestVerifyAPIKey object at 0x78e097317dd0>

    def test_verify_api_key_logging_invalid_key(self):
        """Test that invalid API key attempts are logged"""
        # Standard library imports
        from unittest.mock import Mock
    
        from app.auth import verify_api_key
    
        with patch.dict(
            os.environ, {"API_KEYS": "valid_key", "REQUIRE_API_KEY": "true"}
        ), patch("app.auth.logger") as mock_logger:
            mock_request = Mock()
            mock_request.url.path = "/api/test"
            mock_request.client = Mock()
            mock_request.client.host = "192.168.1.1"
            mock_request.headers = {}
            mock_request.query_params = {}
    
            # This should raise an exception and log the invalid attempt
            try:
                verify_api_key(mock_request, None)
            except Exception:
                pass
    
            # Verify that warning was logged for invalid key attempt
>           mock_logger.warning.assert_called()
E           AssertionError: Expected 'warning' to have been called.

tests/manual/test_auth.py:145: AssertionError
__________ TestRequestLoggingMiddleware.test_dispatch_with_exception ___________

request = <Mock id='132902523315328'>

    async def failing_call_next(request):
>       raise Exception("Test error")
E       Exception: Test error

tests/manual/test_middleware.py:248: Exception

During handling of the above exception, another exception occurred:

self = <app.middleware.RequestLoggingMiddleware object at 0x78dfc7b123f0>
request = <Mock id='132902523315328'>
call_next = <function TestRequestLoggingMiddleware.test_dispatch_with_exception.<locals>.failing_call_next at 0x78dfcc955b20>

    async def dispatch(
        self, request: Request, call_next: Callable[[Request], Awaitable[Response]]
    ) -> Response:
        start_time = time.time()
        request_id = request.headers.get(
            "X-Request-ID", f"req-{int(start_time * 1000)}"
        )
    
        logger.info(
            json.dumps(
                {
                    "event": "request_started",
                    "request_id": request_id,
                    "method": request.method,
                    "path": request.url.path,
                    "client_ip": self.get_client_id(request),
                    "timestamp": start_time,
                }
            )
        )
    
        try:
            response = await call_next(request)
    
            duration = time.time() - start_time
            logger.info(
                json.dumps(
                    {
                        "event": "request_completed",
                        "request_id": request_id,
                        "status_code": response.status_code,
                        "duration_ms": duration * 1000,
                        "timestamp": time.time(),
                    }
                )
            )
    
            response.headers["X-Request-ID"] = request_id
            return response
    
        except Exception as e:
            duration = time.time() - start_time
            logger.error(
                json.dumps(
                    {
                        "event": "request_failed",
                        "request_id": request_id,
                        "error": str(e),
                        "duration_ms": duration * 1000,
>                       "timestamp": time.time(),
                    }
                )
            )

../../test-repos/clinic/app/middleware.py:155: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib/python3.12/unittest/mock.py:1134: in __call__
    return self._mock_call(*args, **kwargs)
/usr/lib/python3.12/unittest/mock.py:1138: in _mock_call
    return self._execute_mock_call(*args, **kwargs)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

self = <MagicMock name='time' id='132902523315520'>, args = (), kwargs = {}
effect = <list_iterator object at 0x78dfc7b13460>

    def _execute_mock_call(self, /, *args, **kwargs):
        # separate from _increment_mock_call so that awaited functions are
        # executed separately from their call, also AsyncMock overrides this method
    
        effect = self.side_effect
        if effect is not None:
            if _is_exception(effect):
                raise effect
            elif not _callable(effect):
>               result = next(effect)
E               StopIteration

/usr/lib/python3.12/unittest/mock.py:1195: StopIteration

The above exception was the direct cause of the following exception:

self = <manual.test_middleware.TestRequestLoggingMiddleware object at 0x78e09714db80>
middleware = <app.middleware.RequestLoggingMiddleware object at 0x78dfc7b123f0>

    @pytest.mark.asyncio
    async def test_dispatch_with_exception(self, middleware):
        """Test request dispatch with exception"""
        mock_request = Mock()
        mock_request.method = "POST"
        mock_request.url.path = "/api/test"
        mock_request.headers = {}
        mock_request.client = None
    
        async def failing_call_next(request):
            raise Exception("Test error")
    
        with patch("time.time", side_effect=[1000.0, 1000.3]), patch(
            "app.middleware.logger"
        ) as mock_logger:
            with pytest.raises(Exception, match="Test error"):
>               await middleware.dispatch(mock_request, failing_call_next)
E               RuntimeError: coroutine raised StopIteration

tests/manual/test_middleware.py:254: RuntimeError

During handling of the above exception, another exception occurred:

self = <manual.test_middleware.TestRequestLoggingMiddleware object at 0x78e09714db80>
middleware = <app.middleware.RequestLoggingMiddleware object at 0x78dfc7b123f0>

    @pytest.mark.asyncio
    async def test_dispatch_with_exception(self, middleware):
        """Test request dispatch with exception"""
        mock_request = Mock()
        mock_request.method = "POST"
        mock_request.url.path = "/api/test"
        mock_request.headers = {}
        mock_request.client = None
    
        async def failing_call_next(request):
            raise Exception("Test error")
    
        with patch("time.time", side_effect=[1000.0, 1000.3]), patch(
            "app.middleware.logger"
        ) as mock_logger:
>           with pytest.raises(Exception, match="Test error"):
E           AssertionError: Regex pattern did not match.
E            Regex: 'Test error'
E            Input: 'coroutine raised StopIteration'

tests/manual/test_middleware.py:253: AssertionError
______________ TestClinicalAssertionModel.test_load_model_success ______________

self = <manual.test_model.TestClinicalAssertionModel object at 0x78dfcd7616d0>
mock_cuda = <MagicMock name='is_available' id='132902524030272'>
mock_pipeline = <MagicMock name='TextClassificationPipeline' id='132902524042848'>
mock_model_class = <MagicMock name='from_pretrained' id='132902524128624'>
mock_tokenizer = <MagicMock name='from_pretrained' id='132902524028160'>
model = <app.model.ClinicalAssertionModel object at 0x78dfc7bc0e60>

    @pytest.mark.asyncio
    @patch("app.model.AutoTokenizer.from_pretrained")
    @patch("app.model.AutoModelForSequenceClassification.from_pretrained")
    @patch("app.model.TextClassificationPipeline")
    @patch("torch.cuda.is_available")
    async def test_load_model_success(
        self, mock_cuda, mock_pipeline, mock_model_class, mock_tokenizer, model
    ):
        """Test successful model loading"""
        mock_cuda.return_value = False
    
        # Mock the model and tokenizer
        mock_model_instance = Mock()
        mock_model_class.return_value = mock_model_instance
        mock_tokenizer_instance = Mock()
        mock_tokenizer.return_value = mock_tokenizer_instance
        mock_pipeline_instance = Mock()
        mock_pipeline.return_value = mock_pipeline_instance
    
        await model.load_model()
    
        assert model.tokenizer == mock_tokenizer_instance
>       assert model.model == mock_model_instance
E       AssertionError: assert <Mock name='from_pretrained().to().to()' id='132902523352752'> == <Mock name='from_pretrained()' id='132902524030320'>
E        +  where <Mock name='from_pretrained().to().to()' id='132902523352752'> = <app.model.ClinicalAssertionModel object at 0x78dfc7bc0e60>.model

tests/manual/test_model.py:82: AssertionError
_______________ TestClinicalAssertionModel.test_predict_success ________________

self = <manual.test_model.TestClinicalAssertionModel object at 0x78dfcd7628a0>
mock_loop = <MagicMock name='get_event_loop' id='132902523785088'>
model = <app.model.ClinicalAssertionModel object at 0x78dfc7b84e30>

    @pytest.mark.asyncio
    @patch("asyncio.get_event_loop")
    async def test_predict_success(self, mock_loop, model):
        """Test successful prediction"""
        # Setup model as loaded
        model._loaded = True
        model.model = Mock()
        model.pipeline = Mock()
    
        # Mock the pipeline result
        mock_result = {"label": "LABEL_0", "score": 0.95}
        model.pipeline.return_value = [mock_result]
    
        # Mock asyncio loop
        mock_loop_instance = Mock()
        mock_loop.return_value = mock_loop_instance
        mock_loop_instance.run_in_executor = AsyncMock(return_value=mock_result)
    
        result = await model.predict("test sentence")
    
>       assert result == {"label": "PRESENT", "score": 0.95}
E       AssertionError: assert {'label': 'LA...'score': 0.95} == {'label': 'PR...'score': 0.95}
E         Omitting 1 identical items, use -vv to show
E         Differing items:
E         {'label': 'LABEL_0'} != {'label': 'PRESENT'}
E         Full diff:
E         - {'label': 'PRESENT', 'score': 0.95}
E         ?            ^^ ^^^^
E         + {'label': 'LABEL_0', 'score': 0.95}
E         ?            ^^^ ^^^

tests/manual/test_model.py:145: AssertionError
____________ TestClinicalAssertionModel.test_predict_batch_success _____________

self = <manual.test_model.TestClinicalAssertionModel object at 0x78dfcd7638f0>
mock_loop = <MagicMock name='get_event_loop' id='132902598454752'>
model = <app.model.ClinicalAssertionModel object at 0x78dfcc2bac90>

    @pytest.mark.asyncio
    @patch("asyncio.get_event_loop")
    async def test_predict_batch_success(self, mock_loop, model):
        """Test successful batch prediction"""
        # Setup model as loaded
        model._loaded = True
        model.model = Mock()
        model.pipeline = Mock()
    
        # Mock batch results
        mock_results = [
            [{"label": "LABEL_0", "score": 0.95}],
            [{"label": "LABEL_1", "score": 0.87}],
        ]
        model.pipeline.return_value = mock_results
    
        # Mock asyncio loop
        mock_loop_instance = Mock()
        mock_loop.return_value = mock_loop_instance
        mock_loop_instance.run_in_executor = AsyncMock(return_value=mock_results)
    
        result = await model.predict_batch(["sentence 1", "sentence 2"])
    
        expected = [
            {"label": "PRESENT", "score": 0.95},
            {"label": "ABSENT", "score": 0.87},
        ]
>       assert result == expected
E       AssertionError: assert [[{'label': '...core': 0.87}]] == [{'label': 'P...score': 0.87}]
E         At index 0 diff: [{'label': 'LABEL_0', 'score': 0.95}] != {'label': 'PRESENT', 'score': 0.95}
E         Full diff:
E         - [{'label': 'PRESENT', 'score': 0.95}, {'label': 'ABSENT', 'score': 0.87}]
E         ?             ^^ ^^^^                                - ^^
E         + [[{'label': 'LABEL_0', 'score': 0.95}], [{'label': 'LABEL_1', 'score': 0.87}]]
E         ? +            ^^^ ^^^                 +  +           +   ^^^                  +

tests/manual/test_model.py:237: AssertionError
=============================== warnings summary ===============================
venv/lib/python3.12/site-packages/transformers/utils/generic.py:441
  /home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/transformers/utils/generic.py:441: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
    _torch_pytree._register_pytree_node(

venv/lib/python3.12/site-packages/transformers/utils/generic.py:309
tests/generated/test_e2e_20251114_075814_01.py::test_verify_api_key_behavior_with_env
  /home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/transformers/utils/generic.py:309: FutureWarning: `torch.utils._pytree._register_pytree_node` is deprecated. Please use `torch.utils._pytree.register_pytree_node` instead.
    _torch_pytree._register_pytree_node(

tests/generated/test_e2e_20251114_075814_01.py::test_verify_api_key_behavior_with_env
  /home/sigmoid/TECH_DEMO/new-tech-demo/venv/lib/python3.12/site-packages/huggingface_hub/file_download.py:942: FutureWarning: `resume_download` is deprecated and will be removed in version 1.0.0. Downloads always resume when possible. If you want to force a new download, use `force_download=True`.
    warnings.warn(

tests/generated/test_integ_20251114_075814_01.py::test_service_status_returns_expected_structure
  /home/sigmoid/TECH_DEMO/new-tech-demo/tests/generated/test_integ_20251114_075814_01.py:88: DeprecationWarning: There is no current event loop
    return asyncio.get_event_loop().run_until_complete(coro)

tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key
  /home/sigmoid/TECH_DEMO/new-tech-demo/tests/manual/test_auth.py:140: RuntimeWarning: coroutine 'verify_api_key' was never awaited
    verify_api_key(mock_request, None)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.12.3-final-0 -----------
Name                                                Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------
/home/sigmoid/test-repos/clinic/app/__init__.py         1      0      0      0   100%
/home/sigmoid/test-repos/clinic/app/auth.py            39     15     18      2    53%   42, 47-70
/home/sigmoid/test-repos/clinic/app/main.py           154     12     16      2    92%   89-91, 97->100, 160, 333-336, 432-437
/home/sigmoid/test-repos/clinic/app/middleware.py      92      0     14      0   100%
/home/sigmoid/test-repos/clinic/app/model.py           82      3     14      1    96%   45->48, 117-119
/home/sigmoid/test-repos/clinic/app/schemas.py         70      3     10      3    92%   37, 86, 94
/home/sigmoid/test-repos/clinic/app/utils.py           49      5     12      3    87%   26-28, 39, 55, 104->108
-----------------------------------------------------------------------------------------------
TOTAL                                                 487     38     84     11    90%
Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml

=========================== short test summary info ============================
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_metrics_endpoint_returns_prometheus_content
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_model_info_unavailable_and_available
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_predict_assertion_success_and_failure
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_predict_batch_success_and_over_limit
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_system_metrics_and_root_respect_model_loaded_flag
FAILED tests/generated/test_e2e_20251114_075814_01.py::test_general_exception_handler_catches_unexpected_errors
FAILED tests/generated/test_integ_20251114_075814_01.py::test_health_check_raises_if_model_none
FAILED tests/generated/test_integ_20251114_075814_01.py::test_model_info_returns_model_info_when_loaded
FAILED tests/generated/test_unit_20251114_075814_01.py::test_dispatch_method_success_and_exception
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_no_keys_required
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_missing_from_request
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_invalid
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_bearer
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_header
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_valid_query_param
FAILED tests/manual/test_auth.py::TestVerifyAPIKey::test_verify_api_key_logging_invalid_key
FAILED tests/manual/test_middleware.py::TestRequestLoggingMiddleware::test_dispatch_with_exception
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_load_model_success
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_success
FAILED tests/manual/test_model.py::TestClinicalAssertionModel::test_predict_batch_success
=========== 20 failed, 107 passed, 12 skipped, 6 warnings in 31.98s ============

ðŸ“Š Combined Coverage Analysis:
Name                                                Stmts   Miss Branch BrPart  Cover   Missing
-----------------------------------------------------------------------------------------------
/home/sigmoid/test-repos/clinic/app/__init__.py         1      0      0      0   100%
/home/sigmoid/test-repos/clinic/app/auth.py            39     15     18      2    53%   42, 47-70
/home/sigmoid/test-repos/clinic/app/main.py           157     14     18      3    90%   89-91, 97->100, 160, 333-336, 432-437, 558-559
/home/sigmoid/test-repos/clinic/app/middleware.py      92      0     14      0   100%
/home/sigmoid/test-repos/clinic/app/model.py           82      3     14      1    96%   45->48, 117-119
/home/sigmoid/test-repos/clinic/app/schemas.py         70      3     10      3    92%   37, 86, 94
/home/sigmoid/test-repos/clinic/app/utils.py           49      5     12      3    87%   26-28, 39, 55, 104->108
-----------------------------------------------------------------------------------------------
TOTAL                                                 490     40     86     12    89%

= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
FINAL RESULTS
= =4.2 backend_code.log clinic1.log clinic-2.log clinic.log clinic-loop-1.log clinic-loop.log clinic-loop-max-2.log clinic-loop-max-3.log clinic-loop-max-4.log clinic-loop-max-iteartions-2.log coverage_gaps.json coverage.xml feature.log flask-high-coverage-repo.log htmlcov local_artifacts local_pipeline-1.sh manual_test_result.json output_combined.log PIPELINE_SUMMARY.md pytest.ini QUALITY_GATE_SUMMARY.md requirements.txt src test.db tests venv 80
âœ… Manual Test Coverage:   85.01%
âœ… Combined Line Coverage:      92.20%
ðŸ“ˆ Coverage Improvement:   7.19%

ðŸŽ‰ Quality Gate Passed: Coverage 92.20% â‰¥ 90%

âœ… Pipeline completed successfully!
