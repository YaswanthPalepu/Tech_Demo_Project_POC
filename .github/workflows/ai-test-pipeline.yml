name: AI Test Generation Pipeline

# Manual trigger ONLY - no automatic runs
on:
  workflow_dispatch:  # Trigger manually from GitHub UI

jobs:
  run-ai-test-pipeline:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-json-report

    - name: Run AI Test Generation Pipeline
      env:
        # Pass GitHub Secret to environment variable
        GIT_PUSH_TOKEN: ${{ secrets.GIT_PUSH_TOKEN }}
        TARGET_DIR: ${{ github.workspace }}/target_repo
        MIN_COVERAGE_THRESHOLD: 90
      run: |
        chmod +x pipeline_runner.sh
        ./pipeline_runner.sh

    - name: Upload coverage reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: coverage-reports
        path: |
          coverage.xml
          htmlcov/
          test-results.xml

    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          .pytest_*.json
          manual_test_result.json
