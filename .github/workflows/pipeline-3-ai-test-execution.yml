name: Pipeline 3 - AI Test Execution and Quality Gates

on:
  # workflow_run:
  #   workflows: ["Pipeline 2 - AI Test Generation"]
  #   types:
  #     - completed
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target repository"
        required: true
        default: "DeviPrasad372002/flask-test-repo"
      ref:
        description: "Branch or SHA to test"
        default: "main"
      python_version:
        description: "Python version"
        default: "3.12"
      min_coverage:
        description: "Minimum test coverage percentage"
        default: "80"

permissions:
  contents: read
  actions: read
  security-events: write

concurrency:
  group: ai-test-execution-${{ github.event.repository.full_name }}-${{ github.ref_name }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GH_PAT3 }}
  SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL}} 
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  execute-ai-tests:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: self-hosted
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.target_repo || 'DeviPrasad372002/flask-test-repo' }}
          ref: ${{ github.event.inputs.ref || 'main' }}
          token: ${{ secrets.GH_PAT3 }}
          path: target

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}

      - name: Install project deps
        working-directory: target
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov httpx

      - name: Run tests with coverage (BLOCKING)
        id: tests
        working-directory: target
        run: |
          pytest tests/generated \
            --cov=. \
            --cov-report=term-missing:skip-covered \
            --cov-report=xml \
            --cov-report=html \
            --cov-fail-under=${{ github.event.inputs.min_coverage }} \
            -v
        continue-on-error: false

      - name: Parse coverage percentage
        id: coverage
        if: always()
        working-directory: target
        run: |
          if [ -f coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(f\"{float(root.attrib['line-rate']) * 100:.2f}\")")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "‚úÖ Test Coverage: $COVERAGE%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "‚ùå No coverage report generated"
          fi

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            target/coverage.xml
            target/htmlcov/
          if-no-files-found: warn

      - name: SonarQube Scan with Quality Gate
        id: sonar
        if: env.SONAR_HOST_URL && env.SONAR_TOKEN
        uses: SonarSource/sonarqube-scan-action@v2.3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.event.inputs.target_repo }}
            -Dsonar.projectName=${{ github.event.inputs.target_repo }}
            -Dsonar.sources=target
            -Dsonar.exclusions=**/tests/**,**/tests_generated/**,**/tests/generated/**
            -Dsonar.python.coverage.reportPaths=target/coverage.xml
            -Dsonar.qualitygate.wait=true
            -Dsonar.qualitygate.timeout=300

      - name: Check SonarQube Quality Gate
        if: env.SONAR_HOST_URL && env.SONAR_TOKEN
        run: |
          echo "üîç SonarQube Analysis Complete"
          echo "Dashboard: ${{ env.SONAR_HOST_URL }}/dashboard?id=${{ github.event.inputs.target_repo }}"

      - name: Quality Gate Summary
        if: always()
        run: |
          echo "## üìä Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|-------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.tests.outcome }}" == "success" ]; then
            echo "| ‚úÖ Unit Tests | PASSED | All tests passing |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ‚ùå Unit Tests | FAILED | Some tests failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "| üìà Code Coverage | ${{ steps.coverage.outputs.coverage }}% | Min: ${{ github.event.inputs.min_coverage }}% |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.sonar.outcome }}" == "success" ]; then
            echo "| ‚úÖ SonarQube | PASSED | Quality gate passed |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.sonar.outcome }}" == "failure" ]; then
            echo "| ‚ùå SonarQube | FAILED | Quality gate failed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ‚ö†Ô∏è SonarQube | SKIPPED | Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links" >> $GITHUB_STEP_SUMMARY
          echo "- [SonarQube Dashboard](${{ env.SONAR_HOST_URL }}/dashboard?id=${{ github.event.inputs.target_repo }})" >> $GITHUB_STEP_SUMMARY

      - name: Final Gate Check
        if: always()
        run: |
          if [ "${{ steps.tests.outcome }}" != "success" ] || [ "${{ steps.sonar.outcome }}" == "failure" ]; then
            echo "‚ùå Quality gates failed. Deployment blocked."
            exit 1
          fi
          echo "‚úÖ All quality gates passed. Ready for deployment."